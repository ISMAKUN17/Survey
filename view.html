<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secrets Royal Beach - Survey Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para consistencia - Diseño Moderno */
        :root {
            /* Paleta de colores moderna */
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --secondary-color: #64748b;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            
            /* Colores de fondo modernos */
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --surface-color: #f1f5f9;
            
            /* Colores de texto */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            
            /* Bordes y sombras */
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            /* Colores para las calificaciones (emojis y texto) */
            --face-bad: #ef4444;
            --face-poor: #f59e0b;
            --face-regular: #eab308;
            --face-good: #06b6d4;
            --face-excellent: #10b981;
            
            /* Espaciado moderno */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Bordes redondeados */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
        }

        /* Estilos generales del cuerpo */
        body {
            font-family: 'Inter', 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            margin: 0;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
            font-weight: 400;
        }

        /* Contenedor principal del dashboard */
        .container {
            background: var(--card-background);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            padding: var(--spacing-2xl);
            width: 100%;
            max-width: 1200px;
            text-align: center;
            margin-bottom: var(--spacing-lg);
            animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Animación de entrada mejorada */
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* Estilos para el logo */
        .logo {
            max-width: 200px;
            margin-bottom: var(--spacing-md);
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        /* Estilos para los títulos */
        h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        h2 {
            color: var(--text-primary);
            font-size: 2rem;
            margin-top: var(--spacing-2xl);
            margin-bottom: var(--spacing-lg);
            font-weight: 700;
            position: relative;
            padding-bottom: var(--spacing-md);
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
        }

        /* Grid para las tarjetas de resumen */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }

        /* Estilos para las tarjetas de resumen */
        .summary-card {
            background: linear-gradient(135deg, var(--card-background) 0%, var(--surface-color) 100%);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-md);
            text-align: left;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .summary-card:hover::before {
            transform: scaleX(1);
        }

        .summary-card h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        .summary-card p {
            font-size: 1.125rem;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Contenedor para el gráfico */
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 0 auto var(--spacing-xl) auto;
            background: var(--card-background);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            box-sizing: border-box;
            border: 1px solid var(--border-light);
            position: relative;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
        }

        /* Sección de comentarios */
        .comments-section {
            text-align: left;
            margin-top: var(--spacing-xl);
        }

        /* Tarjeta de comentario individual */
        .comment-card {
            background: var(--card-background);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            position: relative;
        }

        .comment-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .comment-card p {
            margin: 0;
            font-size: 1rem;
            word-wrap: break-word;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .comment-card small {
            display: block;
            margin-top: var(--spacing-md);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Estilos para paginación de comentarios */
        .comments-pagination {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .pagination-info {
            text-align: center;
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .pagination-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }

        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .pagination-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .page-numbers {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
        }

        .page-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: var(--card-background);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid var(--border-light);
        }

        .page-number:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .page-number.active {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .page-ellipsis {
            color: var(--text-muted);
            font-weight: 600;
            padding: 0 var(--spacing-xs);
        }

        .pagination-size {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-size select {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs) var(--spacing-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-left: var(--spacing-xs);
        }

        .pagination-size select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Mensajes de estado */
        .loading-message, .no-data-message, .error-message {
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
            margin-top: var(--spacing-2xl);
            font-size: 1.25rem;
            padding: var(--spacing-xl);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        /* Spinner de carga */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-lg) auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-subtitle {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            margin-top: var(--spacing-sm);
        }

        .error-message {
            color: var(--error-color);
            font-weight: 600;
            background: #fef2f2;
            border-color: #fecaca;
        }

        .error-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .error-text {
            margin: 0;
        }

        .retry-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Estilos para los botones de acción */
        .dashboard-actions {
            margin-top: var(--spacing-xl);
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .dashboard-actions button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .dashboard-actions button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .dashboard-actions button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .dashboard-actions button:hover::before {
            left: 100%;
        }

        .dashboard-actions button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }

        /* Estilos para los controles de filtro */
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            justify-content: center;
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--background-color) 100%);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .filter-controls h3 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin: 0 0 var(--spacing-lg) 0;
            text-align: center;
            font-weight: 700;
        }

        .filter-section {
            background: var(--card-background);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        .filter-section h4 {
            color: var(--primary-color);
            font-size: 1.125rem;
            margin: 0 0 var(--spacing-md) 0;
            font-weight: 600;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-sm);
        }

        .filter-row {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-group input[type="date"],
        .filter-group input[type="text"],
        .filter-group input[type="number"],
        .filter-group select {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--card-background);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .filter-group input[type="date"]:focus,
        .filter-group input[type="text"]:focus,
        .filter-group input[type="number"]:focus,
        .filter-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .filter-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            flex-basis: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-actions button {
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            min-width: 140px;
        }

        .active-filters {
            background: var(--success-color);
            color: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .active-filters h4 {
            color: white;
            margin: 0 0 var(--spacing-md) 0;
            font-size: 1.125rem;
        }

        .active-filters-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .active-filter-tag {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .active-filter-tag .remove-filter {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            margin-left: var(--spacing-xs);
        }

        .active-filter-tag .remove-filter:hover {
            opacity: 0.8;
        }

        #applyFiltersBtn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        #applyFiltersBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        #resetFiltersBtn {
            background: linear-gradient(135deg, var(--secondary-color), #475569);
            color: white;
        }

        #resetFiltersBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Estilos del Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            padding: var(--spacing-lg);
        }

        .modal-content {
            background: var(--card-background);
            margin: auto;
            padding: var(--spacing-2xl);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 800px;
            position: relative;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-light);
        }

        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .close-button {
            color: var(--text-secondary);
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-xl);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--surface-color);
        }

        .close-button:hover {
            color: var(--error-color);
            background: #fef2f2;
            transform: scale(1.1);
        }

        .modal-content h3 {
            color: var(--text-primary);
            font-size: 1.75rem;
            margin-top: 0;
            margin-bottom: var(--spacing-lg);
            font-weight: 700;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-md);
        }

        .survey-detail-card {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .survey-detail-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .survey-detail-card p {
            margin: var(--spacing-sm) 0;
            font-size: 1rem;
        }

        .survey-detail-card strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .survey-detail-card .rating-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Estilos para el Modal de Tabla */
        #tableModal .modal-content {
            max-width: 95%;
            width: auto;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            gap: var(--spacing-md);
            flex-wrap: wrap;
            padding: var(--spacing-lg);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .table-controls input[type="search"] {
            flex-grow: 1;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            background: var(--card-background);
            transition: all 0.2s ease;
        }

        .table-controls input[type="search"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .pagination-controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .pagination-controls button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .pagination-controls button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .pagination-controls button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.7;
        }

        #currentPage {
            font-weight: 700;
            color: var(--primary-color);
        }

        .survey-table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .survey-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-md);
            font-size: 0.9rem;
            white-space: nowrap;
            background: var(--card-background);
        }

        .survey-table th, .survey-table td {
            border: 1px solid var(--border-light);
            padding: var(--spacing-md);
            text-align: left;
        }

        .survey-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .survey-table tbody tr:nth-child(even) {
            background: var(--surface-color);
        }

        .survey-table tbody tr:hover {
            background: var(--border-light);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }
            
            .container {
                padding: var(--spacing-lg);
                max-width: 100%;
            }
            
            h1 {
                font-size: 2.25rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-card h3 {
                font-size: 1.125rem;
            }
            
            .chart-container {
                height: 300px;
                padding: var(--spacing-lg);
            }
            
            .dashboard-actions button {
                width: 100%;
                margin-bottom: var(--spacing-sm);
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .filter-group {
                width: 100%;
                align-items: center;
            }
            
            .filter-actions {
                flex-direction: column;
                align-items: center;
                width: 100%;
            }
            
            .modal-content {
                padding: var(--spacing-lg);
                width: 95%;
            }
            
            .close-button {
                font-size: 1.75rem;
                top: var(--spacing-md);
                right: var(--spacing-lg);
            }
            
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-controls input[type="search"] {
                margin-bottom: var(--spacing-md);
            }
            
            .pagination-controls {
                justify-content: center;
                width: 100%;
            }
            
            .survey-table th, .survey-table td {
                padding: var(--spacing-sm);
            }
        }

        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
            }
            
            .container {
                padding: var(--spacing-md);
            }
            
            h1 {
                font-size: 1.875rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .summary-card {
                padding: var(--spacing-lg);
            }
            
            .summary-card p {
                font-size: 1rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .comment-card {
                padding: var(--spacing-md);
            }
        }

        /* Estilos específicos para impresión */
        @media print {
            body {
                background: #fff;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                padding: var(--spacing-lg);
                max-width: 100%;
            }
            
            .logo {
                max-width: 150px;
                margin-bottom: var(--spacing-sm);
            }
            
            h1, h2 {
                color: #000;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .filter-controls, .dashboard-actions, .modal {
                display: none !important;
            }
            
            .summary-card, .comment-card {
                border: 1px solid #ccc;
                box-shadow: none;
                page-break-inside: avoid;
            }
            
            .chart-container {
                break-inside: avoid;
                margin-bottom: var(--spacing-lg);
            }
            
            ::-webkit-scrollbar {
                display: none;
            }
            
            body {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        .summary-card .value span[title] {
            cursor: help;
        }

        /* TOP BUTLERS MODAL - Diseño Moderno */
        #topButlersModal .modal-content {
            max-width: 480px;
            padding: var(--spacing-xl);
        }
        
        .top-butlers-cards {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .top-butler-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-lg);
            min-width: 100px;
            min-height: 120px;
            text-align: center;
            position: relative;
            flex: 1 1 100px;
            max-width: 140px;
            border: 2px solid #f59e0b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .top-butler-card:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }
        
        .top-butler-medal {
            font-size: 1.75rem;
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .top-butler-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            margin: 0 auto var(--spacing-sm) auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            border: 2px solid #f59e0b;
            box-shadow: var(--shadow-md);
        }
        
        .top-butler-name {
            font-size: 1rem;
            font-weight: 700;
            margin: var(--spacing-sm) 0 var(--spacing-xs) 0;
            color: var(--text-primary);
        }
        
        .top-butler-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .top-butlers-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .top-butlers-list li {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .top-butlers-list li:hover {
            background: var(--border-light);
            transform: translateX(4px);
        }
        
        .top-butler-rank {
            font-size: 1.125rem;
            font-weight: 800;
            color: var(--primary-color);
            width: 24px;
            text-align: center;
        }
        
        .top-butler-bar {
            flex: 1;
            height: 8px;
            border-radius: var(--radius-sm);
            background: linear-gradient(90deg, #fde68a 0%, #f59e0b 100%);
            margin: 0 var(--spacing-sm);
            position: relative;
            overflow: hidden;
        }
        
        .top-butler-bar-inner {
            height: 100%;
            border-radius: var(--radius-sm);
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            transition: width 0.5s ease;
        }
        
        .top-butler-list-name {
            font-weight: 700;
            color: var(--text-primary);
            min-width: 80px;
            font-size: 1rem;
        }
        
        .top-butler-list-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 32px;
            text-align: right;
        }

        /* BUTLER EFFECTIVENESS MODAL - Diseño Profesional Moderno */
        #butlerEffectivenessModal .modal-content {
            max-width: 1000px;
            padding: var(--spacing-xl);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }
        
        #butlerEffectivenessModal h3 {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: var(--spacing-lg);
            letter-spacing: -0.02em;
        }
        
        .butler-effectiveness-legend {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            font-size: 0.85rem;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }
        
        .butler-effectiveness-legend span {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
        
        .butler-effectiveness-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }
        
        .butler-effectiveness-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .butler-effectiveness-list li {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            font-size: 0.95rem;
            box-shadow: var(--shadow-md);
            font-weight: 500;
            background: var(--card-background);
            border: 1px solid var(--border-light);
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .butler-effectiveness-list li::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .butler-effectiveness-list li:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .butler-effectiveness-list li:hover::before {
            opacity: 1;
        }
        
        .butler-effectiveness-list li.baja {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: var(--error-color);
            border-color: #fecaca;
        }
        
        .butler-effectiveness-list li.media {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: var(--warning-color);
            border-color: #fde68a;
        }
        
        .butler-effectiveness-list li.alta {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: var(--success-color);
            border-color: #a7f3d0;
        }
        
        .butler-effectiveness-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 800;
            color: white;
            margin-right: var(--spacing-md);
            border: 2px solid white;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .butler-effectiveness-avatar::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: transform 0.6s ease;
        }
        
        .butler-effectiveness-list li:hover .butler-effectiveness-avatar::after {
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .butler-effectiveness-rank {
            font-weight: 900;
            color: var(--primary-color);
            width: 28px;
            height: 28px;
            text-align: center;
            font-size: 1rem;
            margin-right: var(--spacing-md);
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }
        
        .butler-effectiveness-name {
            font-weight: 700;
            min-width: 120px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-right: var(--spacing-md);
            letter-spacing: -0.01em;
        }
        
        .butler-effectiveness-avg {
            font-size: 1.1rem;
            font-weight: 800;
            margin-left: var(--spacing-sm);
            min-width: 60px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .butler-effectiveness-bar {
            flex: 1;
            height: 12px;
            border-radius: var(--radius-lg);
            background: var(--border-light);
            margin: 0 var(--spacing-md);
            position: relative;
            overflow: hidden;
            min-width: 150px;
            max-width: 300px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .butler-effectiveness-bar-inner {
            height: 100%;
            border-radius: var(--radius-xl);
            background: linear-gradient(90deg, var(--success-color) 0%, #34d399 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .butler-effectiveness-bar-inner::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .butler-effectiveness-list li.baja .butler-effectiveness-bar-inner {
            background: linear-gradient(90deg, var(--error-color) 0%, #f87171 100%);
        }
        
        .butler-effectiveness-list li.media .butler-effectiveness-bar-inner {
            background: linear-gradient(90deg, var(--warning-color) 0%, #fbbf24 100%);
        }
        
        .butler-effectiveness-badge {
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xs) var(--spacing-md);
            margin-left: var(--spacing-md);
            color: white;
            background: var(--text-muted);
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }
        
        .butler-effectiveness-badge.baja {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }
        
        .butler-effectiveness-badge.media {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }
        
        .butler-effectiveness-badge.alta {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }
        
        /* Estilos para la información de encuestas */
        .butler-effectiveness-list li span:last-child {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: var(--spacing-md);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
        }

        .description {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-bottom: var(--spacing-xl);
            font-weight: 400;
            opacity: 0.9;
        }

        /* Estilos para el Modal de Email */
        #emailReportModal .modal-content {
            max-width: 700px;
            padding: var(--spacing-2xl);
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-group input[type="email"],
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--card-background);
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-group input[type="email"]:focus,
        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: var(--spacing-xs);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: var(--spacing-sm);
        }

        .form-group label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }

        .email-preview {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-light);
            margin: var(--spacing-lg) 0;
        }

        .email-preview h4 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
        }

        .email-preview p {
            margin: var(--spacing-sm) 0;
            color: var(--text-secondary);
        }

        .email-preview strong {
            color: var(--text-primary);
        }

        .email-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--spacing-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color), #475569);
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Responsive para el modal de email */
        @media (max-width: 768px) {
            #emailReportModal .modal-content {
                padding: var(--spacing-lg);
                margin: var(--spacing-md);
            }
            
            .email-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
            }
        }

        /* Estilos para el Modal de Comentarios */
        #commentsModal .modal-content {
            max-width: 1000px;
            padding: var(--spacing-2xl);
            max-height: 90vh;
            overflow-y: auto;
        }

        .comments-modal-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-sm);
        }

        .tab-btn {
            background: var(--surface-color);
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .tab-btn:hover:not(.active) {
            background: var(--border-light);
            transform: translateY(-1px);
        }

        .tab-content {
            position: relative;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .comments-controls,
        .emails-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--card-background);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .filter-select {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-primary);
            background: var(--card-background);
            transition: all 0.2s ease;
            min-width: 150px;
        }

        .filter-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .comments-stats,
        .emails-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
            border: 1px solid var(--border-light);
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .comments-container,
        .emails-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--card-background);
        }

        .comment-item,
        .email-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .comment-item:hover,
        .email-item:hover {
            background: var(--surface-color);
        }

        .comment-item:last-child,
        .email-item:last-child {
            border-bottom: none;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .comment-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .comment-rating {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.8rem;
        }

        .comment-rating.excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .comment-rating.good {
            background: #dbeafe;
            color: #1e40af;
        }

        .comment-rating.regular {
            background: #fef3c7;
            color: #92400e;
        }

        .comment-rating.poor {
            background: #fed7aa;
            color: #c2410c;
        }

        .comment-rating.bad {
            background: #fecaca;
            color: #991b1b;
        }

        .comment-text {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: var(--spacing-sm);
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .email-address {
            font-weight: 600;
            color: var(--text-primary);
            font-family: monospace;
        }

        .email-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .comments-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .pagination-btn {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .emails-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-top: var(--spacing-lg);
        }

        /* Responsive para el modal de comentarios */
        @media (max-width: 768px) {
            #commentsModal .modal-content {
                padding: var(--spacing-lg);
                margin: var(--spacing-md);
            }
            
            .comments-modal-tabs {
                flex-direction: column;
            }
            
            .comments-controls,
            .emails-controls {
                flex-direction: column;
            }
            
            .comments-stats,
            .emails-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .emails-actions {
                flex-direction: column;
            }
        }

        /* Estilos para el Modal de Filtros */
        #filterModal .modal-content {
            max-width: 800px;
            padding: var(--spacing-2xl);
            max-height: 90vh;
            overflow-y: auto;
        }

        .filter-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xl);
        }

        .filter-section {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-light);
        }

        .filter-section h4 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .comparison-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .comparison-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .date-inputs {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .date-inputs input[type="date"] {
            flex: 1;
            padding: var(--spacing-sm);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text-primary);
            background: var(--card-background);
            transition: all 0.2s ease;
        }

        .date-inputs input[type="date"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .date-inputs span {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .compare-result {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--card-background);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            font-size: 0.9rem;
        }

        .filter-summary {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            color: white;
        }

        .filter-summary h4 {
            color: white;
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .filter-summary p {
            margin: 0;
            opacity: 0.9;
        }

        .filter-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--spacing-lg);
        }

        /* Responsive para el modal de filtros */
        @media (max-width: 768px) {
            #filterModal .modal-content {
                padding: var(--spacing-lg);
                margin: var(--spacing-md);
            }
            
            .filter-grid,
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .date-inputs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
            }
        }

        /* Responsive para paginación de comentarios */
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .page-numbers {
                order: -1;
                margin-bottom: var(--spacing-sm);
            }
            
            .pagination-btn {
                width: 100%;
                max-width: 200px;
            }
            
            .page-number {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            .pagination-size {
                margin-top: var(--spacing-md);
            }
        }

        /* Estilos para el logo */
        .logo {
            max-width: 200px;
            margin-bottom: var(--spacing-md);
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }

        /* Estilos para la información de encuestas */
        .butler-effectiveness-list li span:last-child {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: var(--spacing-md);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
        }

        /* BUTLER DETAIL MODAL - Diseño Profesional */
        .butler-detail-content {
            max-width: 600px;
            padding: var(--spacing-2xl);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }

        .butler-detail-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
            padding-bottom: var(--spacing-xl);
            border-bottom: 2px solid var(--border-light);
        }

        .butler-detail-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 800;
            color: white;
            margin: 0 auto var(--spacing-lg);
            border: 6px solid white;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .butler-detail-avatar::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        .butler-detail-name {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            letter-spacing: -0.02em;
        }

        .butler-detail-nps {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
        }

        .butler-detail-level {
            font-size: 1.1rem;
            font-weight: 600;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-xl);
            display: inline-block;
            margin-bottom: var(--spacing-lg);
        }

        .butler-detail-level.alta {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .butler-detail-level.media {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .butler-detail-level.baja {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .butler-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .butler-stat-card {
            background: var(--card-background);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .butler-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .butler-stat-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .butler-stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .butler-stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .butler-stat-percentage {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: var(--spacing-xs);
        }

        .butler-chart-container {
            background: var(--card-background);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-xl);
        }

        .butler-chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .butler-chart-bars {
            display: flex;
            align-items: end;
            gap: var(--spacing-md);
            height: 120px;
            padding: var(--spacing-lg) 0;
        }

        .butler-chart-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .butler-chart-bar-fill {
            width: 100%;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .butler-chart-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .butler-chart-bar-fill.promoters {
            background: linear-gradient(180deg, var(--success-color) 0%, #059669 100%);
        }

        .butler-chart-bar-fill.passives {
            background: linear-gradient(180deg, var(--warning-color) 0%, #d97706 100%);
        }

        .butler-chart-bar-fill.detractors {
            background: linear-gradient(180deg, var(--error-color) 0%, #dc2626 100%);
        }

        .butler-chart-bar-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .butler-chart-bar-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .butler-summary {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            border: 1px solid var(--border-light);
        }

        .butler-summary-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .butler-summary-text {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
            text-align: center;
        }

        /* BUTLER VERIFICATION MODAL - Diseño Profesional */
        .butler-verification-content {
            max-width: 1000px;
            padding: var(--spacing-2xl);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }

        .butler-verification-section {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-light);
        }

        .verification-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-item {
            background: var(--card-background);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .verification-controls {
            display: flex;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            background: var(--card-background);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .sort-select {
            padding: var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            background: var(--card-background);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .butler-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--card-background);
            margin-bottom: var(--spacing-xl);
        }

        .butler-verification-list {
            padding: var(--spacing-lg);
        }

        .butler-verification-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .butler-verification-item:hover {
            background: var(--surface-color);
        }

        .butler-verification-item:last-child {
            border-bottom: none;
        }

        .butler-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .butler-info {
            flex: 1;
        }

        .butler-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .butler-nps {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .verification-actions {
            display: flex;
            gap: var(--spacing-lg);
            justify-content: center;
        }

        .verification-actions button {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-lg);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .verification-actions .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .verification-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .verification-actions .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 2px solid var(--border-light);
        }

        .verification-actions .btn-secondary:hover {
            background: var(--border-light);
            transform: translateY(-2px);
        }

        /* Estilos para posibles duplicados */
        .potential-duplicate {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning-color);
        }

        .potential-duplicate .butler-name {
            color: var(--warning-color);
        }

        /* Estilos para nombres únicos */
        .unique-butler {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid var(--success-color);
        }

        .unique-butler .butler-name {
            color: var(--success-color);
        }

        /* Estilos para los botones de acción */
        .butler-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .btn-edit, .btn-merge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-edit:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-merge {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-merge:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-merge:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .butler-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .butler-count, .butler-nps, .butler-breakdown {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .butler-breakdown {
            font-size: 0.8rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://images.seeklogo.com/logo-png/34/1/secrets-resorts-spas-logo-png_seeklogo-344670.png" alt="Secrets Royal Beach Logo" class="logo">
        <h1>Secrets Royal Beach - Survey Dashboard</h1>
        <p class="description">Vista General de los Comentarios de Satisfacción del Huésped</p>

        <div id="loading" class="loading-message">
            <div class="loading-spinner"></div>
            <p>Cargando datos desde Firebase...</p>
            <p class="loading-subtitle">Esto puede tomar unos segundos</p>
        </div>
        <div id="noData" class="no-data-message" style="display:none;">No hay datos de encuestas disponibles todavía.</div>
        <div id="error" class="error-message" style="display: none;">
            <div class="error-content">
                <p class="error-text"></p>
                <button id="retryBtn" class="retry-btn">🔄 Reintentar Carga</button>
            </div>
        </div>

        <div id="dashboardContent" style="display:none;">
            <div class="dashboard-actions">
                <button id="filterBtn" class="filter-btn">🔍 Filtros Avanzados</button>
                <button id="exportReportBtn">Exportar Reporte (CSV)</button>
                <button id="emailReportBtn">📧 Enviar Reporte por Email</button>
                <button id="viewCommentsBtn">💬 Ver Todos los Comentarios</button>
                <button id="viewDetailsBtn">Ver Encuestas a Detalle</button>
                <button id="viewTableBtn">Ver en Tabla</button> <button id="printReportBtn">Imprimir Reporte</button>
                <button id="topButlersBtn">Top 10 Mayordomos</button>
                <button id="butlerEffectivenessBtn">Efectividad de Mayordomos</button>
            </div>

            <h2>Resumen General</h2>
            <div class="summary-grid">
                <div class="summary-card" id="totalSurveysCard">
                    <h3>Total de Encuestas</h3>
                    <p class="value" id="totalSurveys">0</p>
                </div>
                <div class="summary-card" id="overallStaffRatingCard">
                    <h3>Calificación Promedio del Personal</h3>
                    <p class="value" id="avgOverallStaffServiceRating">N/A</p>
                </div>
                <div class="summary-card" id="foodQualityRatingCard">
                    <h3>Calificación Promedio Calidad de Comida</h3>
                    <p class="value" id="avgFoodQualityRating">N/A</p>
                </div>
                <div class="summary-card" id="roomConditionRatingCard">
                    <h3>Calificación Promedio Condición Habitación</h3>
                    <p class="value" id="avgRoomConditionRating">N/A</p>
                </div>
                <div class="summary-card" id="preferredClubRatingCard">
                    <h3>Calificación Promedio Preferred Club</h3>
                    <p class="value" id="avgPreferredClubServiceRating">N/A</p>
                </div>
                <div class="summary-card" id="butlerServiceRatingCard">
                    <h3>Calificación Promedio Servicio Mayordomo</h3>
                    <p class="value" id="avgButlerServiceRating">N/A</p>
                </div>
            </div>

            <h2>Distribución de Calificaciones</h2>
            <div class="chart-container">
                <canvas id="ratingsChart"></canvas>
            </div>

            <h2>Comentarios Recientes</h2>
            <div class="comments-section" id="commentsSection">
                <!-- Los comentarios se cargarán dinámicamente con paginación -->
            </div>
        </div>
    </div>

    <div id="surveyDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Encuestas Recibidas a Detalle (Filtradas)</h3>
            <div id="detailedSurveysContainer">
                </div>
        </div>
    </div>

    <div id="tableModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeTableModal">&times;</span>
            <h3>Encuestas en Vista de Tabla</h3>
            <div class="table-controls">
                <input type="search" id="tableSearchInput" placeholder="Buscar en la tabla...">
                <div class="pagination-controls">
                    <button id="prevPageBtn">Anterior</button>
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                    <button id="nextPageBtn">Siguiente</button>
                </div>
                <select id="rowsPerPageSelect">
                    <option value="10">10 por página</option>
                    <option value="25">25 por página</option>
                    <option value="50">50 por página</option>
                    <option value="100">100 por página</option>
                </select>
            </div>
            <div class="survey-table-container">
                <table class="survey-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hab.</th>
                            <th>Mayordomo</th>
                            <th>Personal General</th>
                            <th>Comida</th>
                            <th>Habitación</th>
                            <th>Preferred Club</th>
                            <th>Mayordomo Cal.</th>
                            <th>Comentarios</th>
                        </tr>
                    </thead>
                    <tbody id="surveyTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="topButlersModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeTopButlersModal">&times;</span>
            <h3>Top 10 Mayordomos Más Mencionados</h3>
            <div id="topButlersCards" class="top-butlers-cards"></div>
            <ul id="topButlersList" class="top-butlers-list"></ul>
            <button id="sendTopButlersWhatsappBtn" style="background:#25D366; color:#fff; border:none; border-radius:8px; padding:8px 18px; font-size:1em; font-weight:600; margin-top:8px; cursor:pointer; align-self:center;">
                <span style="font-size:1.2em; vertical-align:middle;">🟢</span> Enviar Top 10 por WhatsApp
            </button>
        </div>
    </div>

    <div id="butlerEffectivenessModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeButlerEffectivenessModal">&times;</span>
            <h3>🏆 Efectividad de Mayordomos - NPS Score</h3>
            <p class="description">Análisis de satisfacción basado en Net Promoter Score (Promotores - Detractores)</p>
            
            <div class="butler-verification-section">
                <button id="verifyButlersBtn" class="btn-secondary">
                    🔍 Verificar y Corregir Mayordomos
                </button>
                <small style="color: var(--text-secondary); margin-top: var(--spacing-sm); display: block;">
                    Revisa y corrige nombres de mayordomos para cálculos precisos
                </small>
            </div>
            
            <div class="butler-effectiveness-legend">
                <span><span class="butler-effectiveness-dot" style="background:#10b981;"></span> Alta (≥ 50)</span>
                <span><span class="butler-effectiveness-dot" style="background:#f59e0b;"></span> Media (0 - 49)</span>
                <span><span class="butler-effectiveness-dot" style="background:#ef4444;"></span> Baja (< 0)</span>
            </div>
            <ul id="butlerEffectivenessList" class="butler-effectiveness-list" style="list-style:none; padding:0; margin:0;"></ul>
        </div>
    </div>

    <!-- Modal de Detalle del Mayordomo -->
    <div id="butlerDetailModal" class="modal">
        <div class="modal-content butler-detail-content">
            <span class="close-button" id="closeButlerDetailModal">&times;</span>
            <div id="butlerDetailContent">
                <!-- El contenido se generará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Verificación de Mayordomos -->
    <div id="butlerVerificationModal" class="modal">
        <div class="modal-content butler-verification-content">
            <span class="close-button" id="closeButlerVerificationModal">&times;</span>
            <h3>🔍 Verificación y Corrección de Mayordomos</h3>
            <p class="description">Revisa y corrige los nombres de mayordomos para asegurar cálculos precisos</p>
            
            <div class="verification-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalButlersCount">0</span>
                    <span class="stat-label">Total Mayordomos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="uniqueButlersCount">0</span>
                    <span class="stat-label">Nombres Únicos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="potentialDuplicatesCount">0</span>
                    <span class="stat-label">Posibles Duplicados</span>
                </div>
            </div>
            
            <div class="verification-controls">
                <input type="text" id="butlerSearchInput" placeholder="🔍 Buscar mayordomo..." class="search-input">
                <select id="butlerSortSelect" class="sort-select">
                    <option value="name">Ordenar por Nombre</option>
                    <option value="count">Ordenar por Cantidad</option>
                    <option value="nps">Ordenar por NPS</option>
                </select>
            </div>
            
            <div class="butler-list-container">
                <div id="butlerVerificationList" class="butler-verification-list">
                    <!-- Lista de mayordomos se generará dinámicamente -->
                </div>
            </div>
            
            <div class="verification-actions">
                <button id="saveButlerCorrectionsBtn" class="btn-primary">💾 Guardar Correcciones</button>
                <button id="exportButlerListBtn" class="btn-secondary">📊 Exportar Lista</button>
            </div>
        </div>
    </div>

    <div id="emailReportModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEmailReportModal">&times;</span>
            <h3>📧 Enviar Reporte por Email</h3>
            
            <div class="email-form">
                <div class="form-group">
                    <label for="emailRecipient">Destinatario(s):</label>
                    <input type="email" id="emailRecipient" placeholder="ejemplo@secrets.com" multiple>
                    <small>Puedes agregar múltiples emails separados por comas</small>
                </div>
                
                <div class="form-group">
                    <label for="emailSubject">Asunto:</label>
                    <input type="text" id="emailSubject" placeholder="Reporte de Satisfacción - Secrets Royal Beach">
                </div>
                
                <div class="form-group">
                    <label for="emailMessage">Mensaje Personalizado:</label>
                    <textarea id="emailMessage" rows="4" placeholder="Escribe un mensaje personalizado para acompañar el reporte..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="emailReportType">Tipo de Reporte:</label>
                    <select id="emailReportType">
                        <option value="summary">Resumen General</option>
                        <option value="detailed">Reporte Detallado</option>
                        <option value="excel">Reporte en Excel</option>
                        <option value="pdf">Reporte en PDF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="emailFrequency">Frecuencia de Envío:</label>
                    <select id="emailFrequency">
                        <option value="once">Envío Único</option>
                        <option value="daily">Diario</option>
                        <option value="weekly">Semanal</option>
                        <option value="monthly">Mensual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="emailIncludeChart"> Incluir gráfico de distribución
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="emailIncludeComments"> Incluir comentarios recientes
                    </label>
                </div>
                
                <div class="email-preview">
                    <h4>📊 Vista Previa del Reporte</h4>
                    <div id="emailPreviewContent">
                        <p><strong>Total de Encuestas:</strong> <span id="previewTotalSurveys">0</span></p>
                        <p><strong>Período:</strong> <span id="previewPeriod">Todos los datos</span></p>
                        <p><strong>Filtros Aplicados:</strong> <span id="previewFilters">Ninguno</span></p>
                    </div>
                </div>
                
                <div class="email-actions">
                    <button id="sendEmailBtn" class="btn-primary">📤 Enviar Reporte</button>
                    <button id="previewEmailBtn" class="btn-secondary">👁️ Vista Previa</button>
                    <button id="saveEmailTemplateBtn" class="btn-secondary">💾 Guardar Plantilla</button>
                </div>
            </div>
        </div>
    </div>

    <div id="commentsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCommentsModal">&times;</span>
            <h3>💬 Todos los Comentarios y Correos</h3>
            
            <div class="comments-modal-tabs">
                <button class="tab-btn active" data-tab="comments">📝 Comentarios</button>
                <button class="tab-btn" data-tab="emails">📧 Correos Capturados</button>
            </div>
            
            <div class="tab-content">
                <!-- Tab de Comentarios -->
                <div id="commentsTab" class="tab-panel active">
                    <div class="comments-controls">
                        <input type="text" id="commentsSearchInput" placeholder="Buscar en comentarios..." class="search-input">
                        <select id="commentsRatingFilter" class="filter-select">
                            <option value="">Todas las calificaciones</option>
                            <option value="Bad">Bad</option>
                            <option value="Poor">Poor</option>
                            <option value="Regular">Regular</option>
                            <option value="Good">Good</option>
                            <option value="Excellent">Excellent</option>
                        </select>
                        <select id="commentsSortBy" class="filter-select">
                            <option value="date-desc">Más recientes</option>
                            <option value="date-asc">Más antiguos</option>
                            <option value="rating-desc">Mejor calificación</option>
                            <option value="rating-asc">Peor calificación</option>
                        </select>
                    </div>
                    
                    <div class="comments-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="totalCommentsCount">0</span>
                            <span class="stat-label">Total Comentarios</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="positiveCommentsCount">0</span>
                            <span class="stat-label">Positivos</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="negativeCommentsCount">0</span>
                            <span class="stat-label">Negativos</span>
                        </div>
                    </div>
                    
                    <div class="comments-container" id="allCommentsContainer">
                        <!-- Los comentarios se cargarán aquí -->
                    </div>
                    
                    <div class="comments-pagination">
                        <button id="prevCommentsBtn" class="pagination-btn">← Anterior</button>
                        <span id="commentsPageInfo">Página 1 de 1</span>
                        <button id="nextCommentsBtn" class="pagination-btn">Siguiente →</button>
                    </div>
                </div>
                
                <!-- Tab de Correos -->
                <div id="emailsTab" class="tab-panel">
                    <div class="emails-controls">
                        <input type="text" id="emailsSearchInput" placeholder="Buscar en correos..." class="search-input">
                        <select id="emailsSortBy" class="filter-select">
                            <option value="date-desc">Más recientes</option>
                            <option value="date-asc">Más antiguos</option>
                            <option value="email-asc">A-Z</option>
                            <option value="email-desc">Z-A</option>
                        </select>
                    </div>
                    
                    <div class="emails-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="totalEmailsCount">0</span>
                            <span class="stat-label">Total Correos</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="uniqueEmailsCount">0</span>
                            <span class="stat-label">Únicos</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="validEmailsCount">0</span>
                            <span class="stat-label">Válidos</span>
                        </div>
                    </div>
                    
                    <div class="emails-container" id="allEmailsContainer">
                        <!-- Los correos se cargarán aquí -->
                    </div>
                    
                    <div class="emails-actions">
                        <button id="exportEmailsBtn" class="btn-primary">📥 Exportar Correos (CSV)</button>
                        <button id="copyEmailsBtn" class="btn-secondary">📋 Copiar Lista</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeFilterModal">&times;</span>
            <h3>🔍 Filtros Avanzados</h3>
            
            <div class="filter-form">
                <div class="filter-section">
                    <h4>📅 Filtros por Fecha</h4>
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="modalStartDate">Fecha Inicio:</label>
                            <input type="date" id="modalStartDate">
                        </div>
                        <div class="form-group">
                            <label for="modalEndDate">Fecha Fin:</label>
                            <input type="date" id="modalEndDate">
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h4>👤 Filtros por Personal</h4>
                    <div class="form-group">
                        <label for="modalButlerFilter">Filtrar por Mayordomo:</label>
                        <select id="modalButlerFilter">
                            <option value="">Todos los Mayordomos</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <h4>⭐ Filtros por Calificación</h4>
                    <div class="form-group">
                        <label for="modalRatingRangeFilter">Rango de Calificación:</label>
                        <select id="modalRatingRangeFilter">
                            <option value="">Todas las calificaciones</option>
                            <option value="Bad">Bad</option>
                            <option value="Poor">Poor</option>
                            <option value="Regular">Regular</option>
                            <option value="Good">Good</option>
                            <option value="Excellent">Excellent</option>
                        </select>
                    </div>
                </div>

                <div class="filter-section">
                    <h4>💬 Filtros por Comentarios</h4>
                    <div class="form-group">
                        <label for="modalCommentKeywordFilter">Palabra Clave en Comentarios:</label>
                        <input type="text" id="modalCommentKeywordFilter" placeholder="Buscar en comentarios...">
                    </div>
                </div>

                <div class="filter-section">
                    <h4>📊 Comparación de Períodos</h4>
                    <div class="comparison-grid">
                        <div class="comparison-group">
                            <label>Período 1:</label>
                            <div class="date-inputs">
                                <input type="date" id="modalCompareStart1" placeholder="Inicio">
                                <span>a</span>
                                <input type="date" id="modalCompareEnd1" placeholder="Fin">
                            </div>
                        </div>
                        <div class="comparison-group">
                            <label>Período 2:</label>
                            <div class="date-inputs">
                                <input type="date" id="modalCompareStart2" placeholder="Inicio">
                                <span>a</span>
                                <input type="date" id="modalCompareEnd2" placeholder="Fin">
                            </div>
                        </div>
                    </div>
                    <button id="modalCompareBtn" class="btn-secondary">📈 Comparar Períodos</button>
                    <div id="modalCompareResult" class="compare-result"></div>
                </div>

                <div class="filter-summary">
                    <h4>📋 Resumen de Filtros Activos</h4>
                    <div id="modalActiveFiltersSummary">
                        <p>No hay filtros aplicados</p>
                    </div>
                </div>

                <div class="filter-actions">
                    <button id="modalApplyFiltersBtn" class="btn-primary">✅ Aplicar Filtros</button>
                    <button id="modalResetFiltersBtn" class="btn-secondary">🔄 Limpiar Filtros</button>
                    <button id="modalSaveFilterPresetBtn" class="btn-secondary">💾 Guardar Preset</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script type="module">
        // Importa los módulos necesarios de Firebase SDK v9+
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // ¡IMPORTANTE! Asegúrate de importar getFirestore y las funciones de Firestore aquí
        import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuración de Firebase (YA ACTUALIZADA CON TUS DATOS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyALR-b68phh_u92V3rw9B9Ei7FcexU2xc8",
            authDomain: "proyectos17-98695.firebaseapp.com",
            projectId: "proyectos17-98695",
            storageBucket: "proyectos17-98695.firebasestorage.app",
            messagingSenderId: "951673973410",
            appId: "1:951673973410:web:4bc355e825cf86308645fb",
            measurementId: "G-6YK06W16FZ"
        };

        // Inicializa la aplicación Firebase
        const app = initializeApp(firebaseConfig);
        // ¡IMPORTANTE! Inicializa Firestore
        const db = getFirestore(app);

        // Variables globales para almacenar los datos
        // allRawSurveysData: Contiene TODAS las encuestas cargadas desde Firebase (sin filtrar)
        let allRawSurveysData = [];
        // filteredSurveysData: Contiene las encuestas actualmente mostradas/filtradas
        let filteredSurveysData = [];
        // filteredAndSearchedData: Contiene las encuestas filtradas Y luego buscadas (para la tabla)
        let filteredAndSearchedData = [];

        // Variables para la paginación de la tabla
        let currentPage = 1;
        let rowsPerPage = 10;
        let totalPages = 1;

        // Mapeo de palabras de calificación a valores numéricos para cálculos
        const ratingMap = {
            "Bad": 1,
            "Poor": 2,
            "Regular": 3,
            "Good": 4,
            "Excellent": 5
        };

        // --- Funciones Auxiliares ---

        /**
         * Normaliza un objeto Date o Firebase Timestamp a una cadena de fecha ISO (YYYY-MM-DD).
         * Esto elimina cualquier componente de hora o zona horaria, permitiendo una comparación simple por día.
         * @param {Date | firebase.firestore.Timestamp} dateInput
         * @returns {string | null} Fecha en formato 'YYYY-MM-DD' o null si es inválido.
         */
        function normalizeDateToISOString(dateInput) {
            let date;
            if (dateInput instanceof Date) {
                date = dateInput;
            } else if (dateInput && typeof dateInput.toDate === 'function') {
                date = dateInput.toDate();
            } else {
                return null;
            }
            // Usa getFullYear, getMonth, getDate para obtener los componentes de la fecha
            // en la zona horaria local del objeto Date, y luego construye la cadena ISO.
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calcula el promedio de una calificación específica
        function calculateAverage(data, field) {
            let total = 0;
            let count = 0;
            data.forEach(doc => {
                const ratingWord = doc[field];
                if (ratingWord && ratingMap[ratingWord] !== undefined) {
                    total += ratingMap[ratingWord];
                    count++;
                }
            });
            return count > 0 ? (total / count).toFixed(2) : "N/A";
        }

        // Obtiene el emoji de cara según el promedio
        function getFaceEmoji(avg) {
            if (avg === "N/A") return "";
            const numAvg = parseFloat(avg);
            if (numAvg >= 4.5) return "😄";
            if (numAvg >= 3.5) return "🙂";
            if (numAvg >= 2.5) return "😐";
            if (numAvg >= 1.5) return "🙁";
            return "😡";
        }

        // Obtiene el color del texto según el promedio
        function getRatingColor(avg) {
            if (avg === "N/A") return "var(--secondary-color)";
            const numAvg = parseFloat(avg);
            if (numAvg >= 4.5) return "var(--face-excellent)";
            if (numAvg >= 3.5) return "var(--face-good)";
            if (numAvg >= 2.5) return "var(--face-regular)";
            if (numAvg >= 1.5) return "var(--face-poor)";
            return "var(--face-bad)";
        }

        function getRatingBadgeColor(rating) {
            if (!rating) return '';
            if (rating === "Bad" || rating === "Poor") return "#dc3545"; // rojo
            if (rating === "Regular") return "#ffc107"; // amarillo
            if (rating === "Good" || rating === "Excellent") return "#28a745"; // verde
            return "";
        }
        function getRatingBadgeBg(rating) {
            if (!rating) return '';
            if (rating === "Bad" || rating === "Poor") return "#fdeaea"; // fondo rojo suave
            if (rating === "Regular") return "#fffbe6"; // fondo amarillo suave
            if (rating === "Good" || rating === "Excellent") return "#eafaf1"; // fondo verde suave
            return "";
        }

        // Instancia global del gráfico Chart.js para poder destruirlo y recrearlo
        let ratingsChartInstance = null;

        // Rellena el menú desplegable de mayordomos con los mayordomos únicos encontrados en las encuestas
        function populateButlerFilter(surveys) {
            const butlerFilterSelect = document.getElementById('modalButlerFilter');
            if (!butlerFilterSelect) return;
            
            butlerFilterSelect.innerHTML = '<option value="">Todos los Mayordomos</option>'; // Opción por defecto

            const uniqueButlers = new Set();
            surveys.forEach(survey => {
                if (survey.butler && survey.butler.trim() !== '') {
                    uniqueButlers.add(survey.butler.trim());
                }
            });

            // Ordena los mayordomos alfabéticamente
            const sortedButlers = Array.from(uniqueButlers).sort();

            sortedButlers.forEach(butler => {
                const option = document.createElement('option');
                option.value = butler;
                option.textContent = butler;
                butlerFilterSelect.appendChild(option);
            });
        }

        // Devuelve el promedio numérico de una lista de encuestas para un campo
        function getNumericAverage(surveys, field) {
            const map = { "Bad": 1, "Poor": 2, "Regular": 3, "Good": 4, "Excellent": 5 };
            const vals = surveys.map(s => map[s[field]]).filter(Boolean);
            if (!vals.length) return null;
            return vals.reduce((a, b) => a + b, 0) / vals.length;
        }

        // Devuelve la tendencia: "up", "down", "same"
        function getTrend(current, previous) {
            if (current == null || previous == null) return "same";
            if (current > previous) return "up";
            if (current < previous) return "down";
            return "same";
        }

        // Devuelve true si hay más de X respuestas "Bad" o "Poor"
        function hasAlert(surveys, field, threshold = 3) {
            const count = surveys.filter(s => s[field] === "Bad" || s[field] === "Poor").length;
            return count >= threshold;
        }

        // --- Función Principal de Carga y Renderizado del Dashboard ---
        async function loadDashboard(filters = {}) {
            const loadingDiv = document.getElementById('loading');
            const noDataDiv = document.getElementById('noData');
            const errorDiv = document.getElementById('error');
            const dashboardContent = document.getElementById('dashboardContent');

            // Muestra el mensaje de carga y oculta el resto
            loadingDiv.style.display = 'block';
            dashboardContent.style.display = 'none';
            noDataDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Actualizar mensaje de carga
            const loadingText = loadingDiv.querySelector('p');
            if (loadingText) {
                loadingText.textContent = 'Conectando a Firebase...';
            }

            try {
                // Solo cargamos los datos brutos de Firebase una vez
                if (allRawSurveysData.length === 0) {
                    // Asegúrate de que 'customer_satisfaction' es el nombre correcto de tu colección en Firestore
                    const qAll = query(collection(db, "customer_satisfaction"), orderBy("timestamp", "desc"));
                    
                    // Actualizar mensaje de progreso
                    if (loadingText) {
                        loadingText.textContent = 'Descargando datos de encuestas...';
                    }
                    
                    // Agregar timeout para evitar carga infinita
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout: La carga de datos tomó demasiado tiempo')), 30000)
                    );
                    
                    const queryPromise = getDocs(qAll);
                    const querySnapshotAll = await Promise.race([queryPromise, timeoutPromise]);
                    
                    querySnapshotAll.forEach((doc) => {
                        allRawSurveysData.push(doc.data());
                    });

                    // Si no hay datos en absoluto en Firebase
                    if (allRawSurveysData.length === 0) {
                        loadingDiv.style.display = 'none';
                        noDataDiv.textContent = "No hay datos de encuestas en la base de datos.";
                        noDataDiv.style.display = 'block';
                        return; // Salir, no hay nada que mostrar
                    }
                    
                    // Actualizar mensaje de progreso
                    if (loadingText) {
                        loadingText.textContent = `Procesando ${allRawSurveysData.length} encuestas...`;
                    }
                    
                    populateButlerFilter(allRawSurveysData); // Rellena el filtro de mayordomos con todos los datos
                }

                // Aplica los filtros a los datos brutos (allRawSurveysData)
                filteredSurveysData = allRawSurveysData.filter(survey => {
                    // Normaliza la fecha de la encuesta a su formato ISO de día (ej. "2025-07-08")
                    const surveyDateISO = normalizeDateToISOString(survey.timestamp);
                    const surveyDateTime = survey.timestamp && survey.timestamp.toDate ? survey.timestamp.toDate() : new Date(survey.timestamp);

                    // === FILTROS DE FECHA ===
                    const filterStartDateISO = filters.startDate ? filters.startDate : null;
                    const filterEndDateISO = filters.endDate ? filters.endDate : null;

                    if (filterStartDateISO && surveyDateISO) {
                        if (surveyDateISO < filterStartDateISO) return false;
                    }
                    if (filterEndDateISO && surveyDateISO) {
                        if (surveyDateISO > filterEndDateISO) return false;
                    }

                    // === FILTROS DE PERSONAL ===
                    if (filters.butler && filters.butler !== "" && survey.butler !== filters.butler) {
                        return false;
                    }

                    if (filters.roomFilter && filters.roomFilter !== "") {
                        const roomNumbers = filters.roomFilter.split(',').map(r => r.trim());
                        if (!roomNumbers.includes(survey.room_number)) {
                            return false;
                        }
                    }

                    // === FILTROS DE CALIFICACIONES ===
                    if (filters.overallStaffFilter && filters.overallStaffFilter !== "" && survey.overall_staff_service !== filters.overallStaffFilter) {
                        return false;
                    }

                    if (filters.foodQualityFilter && filters.foodQualityFilter !== "" && survey.food_quality !== filters.foodQualityFilter) {
                        return false;
                    }

                    if (filters.roomConditionFilter && filters.roomConditionFilter !== "" && survey.room_condition !== filters.roomConditionFilter) {
                        return false;
                    }

                    if (filters.preferredClubFilter && filters.preferredClubFilter !== "" && survey.preferred_club_service !== filters.preferredClubFilter) {
                        return false;
                    }

                    if (filters.butlerServiceFilter && filters.butlerServiceFilter !== "" && survey.butler_service_rating !== filters.butlerServiceFilter) {
                        return false;
                    }

                    // === FILTRO DE RANGO DE CALIFICACIÓN MÍNIMA ===
                    if (filters.ratingRangeFilter && filters.ratingRangeFilter !== "") {
                        const ratingOrder = { "Bad": 1, "Poor": 2, "Regular": 3, "Good": 4, "Excellent": 5 };
                        const minRating = ratingOrder[filters.ratingRangeFilter];
                        
                        const surveyRatings = [
                            ratingOrder[survey.overall_staff_service],
                            ratingOrder[survey.food_quality],
                            ratingOrder[survey.room_condition],
                            ratingOrder[survey.preferred_club_service],
                            ratingOrder[survey.butler_service_rating]
                        ].filter(r => r !== undefined);

                        if (surveyRatings.length > 0 && Math.min(...surveyRatings) < minRating) {
                            return false;
                        }
                    }

                    // === FILTROS DE COMENTARIOS ===
                    if (filters.commentKeywordFilter && filters.commentKeywordFilter !== "") {
                        const keyword = filters.commentKeywordFilter.toLowerCase();
                        if (!survey.comments || !survey.comments.toLowerCase().includes(keyword)) {
                            return false;
                        }
                    }

                    if (filters.commentTypeFilter && filters.commentTypeFilter !== "") {
                        const hasComments = survey.comments && survey.comments.trim() !== '';
                        if (filters.commentTypeFilter === "withComments" && !hasComments) {
                            return false;
                        }
                        if (filters.commentTypeFilter === "withoutComments" && hasComments) {
                            return false;
                        }
                    }

                    if (filters.commentLengthFilter && filters.commentLengthFilter !== "") {
                        const commentLength = survey.comments ? survey.comments.length : 0;
                        if (filters.commentLengthFilter === "short" && commentLength >= 50) {
                            return false;
                        }
                        if (filters.commentLengthFilter === "medium" && (commentLength < 50 || commentLength > 200)) {
                            return false;
                        }
                        if (filters.commentLengthFilter === "long" && commentLength <= 200) {
                            return false;
                        }
                    }

                    // === FILTROS AVANZADOS ===
                    if (filters.timeOfDayFilter && filters.timeOfDayFilter !== "") {
                        const hour = surveyDateTime.getHours();
                        if (filters.timeOfDayFilter === "morning" && (hour < 6 || hour >= 12)) {
                            return false;
                        }
                        if (filters.timeOfDayFilter === "afternoon" && (hour < 12 || hour >= 18)) {
                            return false;
                        }
                        if (filters.timeOfDayFilter === "evening" && (hour < 18 || hour >= 24)) {
                            return false;
                        }
                        if (filters.timeOfDayFilter === "night" && (hour >= 6)) {
                            return false;
                        }
                    }

                    if (filters.dayOfWeekFilter && filters.dayOfWeekFilter !== "") {
                        const dayOfWeek = surveyDateTime.getDay().toString();
                        if (dayOfWeek !== filters.dayOfWeekFilter) {
                            return false;
                        }
                    }

                    return true; // La encuesta pasa todos los filtros
                });

                // === FILTRO DE MÍNIMO DE ENCUESTAS POR MAYORDOMO ===
                if (filters.surveyCountFilter && filters.surveyCountFilter !== "") {
                    const minCount = parseInt(filters.surveyCountFilter);
                    const butlerCounts = {};
                    
                    filteredSurveysData.forEach(survey => {
                        if (survey.butler) {
                            butlerCounts[survey.butler] = (butlerCounts[survey.butler] || 0) + 1;
                        }
                    });

                    filteredSurveysData = filteredSurveysData.filter(survey => {
                        return !survey.butler || butlerCounts[survey.butler] >= minCount;
                    });
                }

                // Inicializa filteredAndSearchedData con los datos filtrados para la tabla
                filteredAndSearchedData = [...filteredSurveysData];

                // Si no hay datos después de aplicar los filtros
                if (filteredSurveysData.length === 0) {
                    loadingDiv.style.display = 'none';
                    noDataDiv.textContent = "No hay datos que coincidan con los filtros aplicados.";
                    noDataDiv.style.display = 'block';
                    return;
                }
                
                // Actualizar mensaje de progreso final
                if (loadingText) {
                    loadingText.textContent = 'Renderizando dashboard...';
                }

                // --- Actualizar el Dashboard con datos filtrados ---
                document.getElementById('totalSurveys').textContent = filteredSurveysData.length;

                const fieldsToAverage = [
                    { fieldName: 'overall_staff_service', elementSuffix: 'OverallStaffServiceRating', title: 'Servicio General del Personal' },
                    { fieldName: 'food_quality', elementSuffix: 'FoodQualityRating', title: 'Calidad de la Comida' },
                    { fieldName: 'room_condition', elementSuffix: 'RoomConditionRating', title: 'Condición de la Habitación' },
                    { fieldName: 'preferred_club_service', elementSuffix: 'PreferredClubServiceRating', title: 'Servicio Preferred Club' },
                    { fieldName: 'butler_service_rating', elementSuffix: 'ButlerServiceRating', title: 'Calificación del Servicio del Mayordomo' }
                ];

                fieldsToAverage.forEach(item => {
                    const avg = calculateAverage(filteredSurveysData, item.fieldName);
                    const emoji = getFaceEmoji(avg);
                    const color = getRatingColor(avg);
                    const targetElement = document.getElementById(`avg${item.elementSuffix}`);
                    if (targetElement) {
                        targetElement.innerHTML = `<span style="color: ${color};">${emoji} ${avg}</span>`;
                    }

                    // --- BADGE DE TENDENCIA Y ALERTA ---
                    // 1. Encuestas de la semana actual y anterior
                    const today = new Date();
                    const getWeek = d => {
                        const date = new Date(d);
                        date.setHours(0,0,0,0);
                        const firstDay = new Date(date.getFullYear(), 0, 1);
                        return Math.ceil((((date - firstDay) / 86400000) + firstDay.getDay() + 1) / 7);
                    };
                    const weekNow = getWeek(today);
                    const yearNow = today.getFullYear();

                    // Encuestas de esta semana y la anterior
                    const surveysThisWeek = filteredSurveysData.filter(s => {
                        const d = s.timestamp ? new Date(s.timestamp.toDate ? s.timestamp.toDate() : s.timestamp) : null;
                        return d && getWeek(d) === weekNow && d.getFullYear() === yearNow;
                    });
                    const surveysLastWeek = filteredSurveysData.filter(s => {
                        const d = s.timestamp ? new Date(s.timestamp.toDate ? s.timestamp.toDate() : s.timestamp) : null;
                        return d && getWeek(d) === weekNow - 1 && d.getFullYear() === yearNow;
                    });

                    const avgThis = getNumericAverage(surveysThisWeek, item.fieldName);
                    const avgLast = getNumericAverage(surveysLastWeek, item.fieldName);
                    const trend = getTrend(avgThis, avgLast);

                    // Badge de tendencia
                    let trendBadge = "";
                    if (trend === "up") trendBadge = `<span title="Mejoró respecto a la semana pasada" style="color: #28a745; font-size:1.2em; margin-left:8px;">▲</span>`;
                    else if (trend === "down") trendBadge = `<span title="Empeoró respecto a la semana pasada" style="color: #dc3545; font-size:1.2em; margin-left:8px;">▼</span>`;
                    else trendBadge = `<span title="Sin cambio respecto a la semana pasada" style="color: #ffc107; font-size:1.2em; margin-left:8px;">●</span>`;

                    // Badge de alerta
                    const alert = hasAlert(surveysThisWeek, item.fieldName, 3); // 3 o más "Bad"/"Poor"
                    let alertBadge = "";
                    if (alert) alertBadge = `<span title="¡Alerta! Muchas respuestas negativas esta semana" style="background:#dc3545; color:#fff; border-radius:8px; padding:2px 8px; margin-left:8px; font-size:0.9em;">ALERTA</span>`;

                    // Inserta los badges en la tarjeta
                    if (targetElement) {
                        targetElement.innerHTML += trendBadge + alertBadge;
                    }
                });

                // --- Configuración y actualización del gráfico ---
                const chartLabels = ["Bad", "Poor", "Regular", "Good", "Excellent"];
                const chartData = {
                    'overall_staff_service': Array(5).fill(0),
                    'food_quality': Array(5).fill(0),
                    'room_condition': Array(5).fill(0),
                    'preferred_club_service': Array(5).fill(0),
                    'butler_service_rating': Array(5).fill(0)
                };

                filteredSurveysData.forEach(survey => {
                    fieldsToAverage.forEach(item => {
                        const ratingWord = survey[item.fieldName];
                        const numericRating = ratingMap[ratingWord];
                        if (numericRating !== undefined) {
                            chartData[item.fieldName][numericRating - 1]++;
                        }
                    });
                });

                const ctx = document.getElementById('ratingsChart').getContext('2d');
                if (ratingsChartInstance) {
                    ratingsChartInstance.destroy(); // Destruye la instancia anterior del gráfico
                }

                // Calcula el máximo valor para el eje Y del gráfico
                let maxCount = 0;
                Object.values(chartData).forEach(dataArray => {
                    const currentMax = Math.max(...dataArray);
                    if (currentMax > maxCount) {
                        maxCount = currentMax;
                    }
                });
                const dynamicSuggestedMax = maxCount + (maxCount * 0.2); // Añade un 20% de padding
                const finalSuggestedMax = Math.max(dynamicSuggestedMax, 5); // Asegura un mínimo de 5

                ratingsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            { label: 'Servicio General del Personal', data: chartData['overall_staff_service'], backgroundColor: 'rgba(0, 123, 255, 0.7)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 },
                            { label: 'Calidad de la Comida', data: chartData['food_quality'], backgroundColor: 'rgba(255, 193, 7, 0.7)', borderColor: 'rgba(255, 193, 7, 1)', borderWidth: 1 },
                            { label: 'Condición de la Habitación', data: chartData['room_condition'], backgroundColor: 'rgba(40, 167, 69, 0.7)', borderColor: 'rgba(40, 167, 69, 1)', borderWidth: 1 },
                            { label: 'Servicio Preferred Club', data: chartData['preferred_club_service'], backgroundColor: 'rgba(23, 162, 184, 0.7)', borderColor: 'rgba(23, 162, 184, 1)', borderWidth: 1 },
                            { label: 'Servicio del Mayordomo', data: chartData['butler_service_rating'], backgroundColor: 'rgba(220, 53, 69, 0.7)', borderColor: 'rgba(220, 53, 69, 1)', borderWidth: 1 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { font: { size: 14, family: 'Nunito' } } },
                            title: { display: false }, // El título del gráfico se gestiona con h2
                            datalabels: { // Plugin para mostrar el valor sobre las barras
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value > 0 ? value : '', // Muestra solo si es > 0
                                font: { weight: 'bold', size: 12 },
                                color: 'var(--text-color)'
                            }
                        },
                        scales: {
                            x: { beginAtZero: true, title: { display: true, text: 'Calificación', font: { size: 14, family: 'Nunito', weight: '600' } }, ticks: { font: { size: 12, family: 'Nunito' } } },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Número de Respuestas', font: { size: 14, family: 'Nunito', weight: '600' } },
                                ticks: { precision: 0, font: { size: 12, family: 'Nunito' } },
                                suggestedMax: finalSuggestedMax // Aplica el máximo dinámico
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // Habilita el plugin datalabels
                });

                // --- Renderizar Comentarios Recientes ---
                const commentsSection = document.getElementById('commentsSection');
                commentsSection.innerHTML = '';
                // Filtra comentarios vacíos o solo con espacios en blanco
                const comments = filteredSurveysData.filter(s => s.comments && s.comments.trim() !== '');

                if (comments.length > 0) {
                    comments.forEach(comment => {
                        const commentCard = document.createElement('div');
                        commentCard.classList.add('comment-card');
                        const formattedTimestamp = comment.timestamp && comment.timestamp.toDate ? new Date(comment.timestamp.toDate()).toLocaleString('es-DO') : 'N/A';
                        const isNew = isCommentNew(comment.timestamp ? (comment.timestamp.toDate ? comment.timestamp.toDate() : comment.timestamp) : null);
                        commentCard.innerHTML = `
                            <p>${comment.comments}</p>
                            ${isNew ? '<span style="background:#28a745; color:#fff; border-radius:8px; padding:2px 8px; margin-left:8px; font-size:0.9em;">Nuevo</span>' : ''}
                            <small>Habitación: ${comment.room_number || 'N/A'} - Mayordomo: ${comment.butler || 'N/A'} - Enviado: ${formattedTimestamp}</small>
                            <button class="whatsapp-comment-btn" 
                                data-comment="${encodeURIComponent(comment.comments)}"
                                data-room="${encodeURIComponent(comment.room_number || 'N/A')}"
                                data-butler="${encodeURIComponent(comment.butler || 'N/A')}"
                                data-date="${encodeURIComponent(formattedTimestamp)}"
                                style="background:#25D366; color:#fff; border:none; border-radius:6px; padding:6px 14px; margin-top:8px; cursor:pointer;">
                                <span style="font-size:1.2em; vertical-align:middle;">🟢</span> Enviar a WhatsApp
                            </button>
                        `;
                        commentsSection.appendChild(commentCard);
                    });
                } else {
                    commentsSection.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">No hay comentarios adicionales con los filtros actuales.</p>';
                }

                // Oculta el mensaje de carga y muestra el contenido del dashboard y los filtros
                loadingDiv.style.display = 'none';
                dashboardContent.style.display = 'block';

            } catch (error) {
                console.error("Error al cargar los datos del dashboard: ", error);
                loadingDiv.style.display = 'none';
                const errorText = errorDiv.querySelector('.error-text');
                errorText.textContent = `Error al cargar los datos: ${error.message}. Por favor, revisa tu conexión a Firebase y las Reglas de Seguridad de Firestore.`;
                errorDiv.style.display = 'block';
                noDataDiv.style.display = 'none';
            }
        }

        // --- Función para Exportar a CSV (Reporte Bonito y Organizado) ---
        // Esta función ahora toma 'data' como parámetro, que será 'filteredSurveysData'
        function exportToCsv(filename, data) {
            if (!data || data.length === 0) {
                alert('No hay datos para generar el reporte. Aplica filtros o asegúrate de tener encuestas.');
                return;
            }

            // Define el orden y los títulos de las columnas para el CSV
            const columnOrder = [
                'timestamp',
                'room_number',
                'butler',
                'overall_staff_service',
                'food_quality',
                'room_condition',
                'preferred_club_service',
                'butler_service_rating',
                'comments'
            ];

            const columnTitles = {
                'timestamp': 'Fecha y Hora',
                'room_number': 'Número de Habitación',
                'butler': 'Mayordomo Asignado',
                'overall_staff_service': 'Servicio General del Personal',
                'food_quality': 'Calidad de la Comida',
                'room_condition': 'Condición de la Habitación',
                'preferred_club_service': 'Servicio Preferred Club',
                'butler_service_rating': 'Calificación del Servicio del Mayordomo',
                'comments': 'Comentarios Adicionales'
            };

            // Función para formatear valores para el CSV
            const replacer = (key, value) => {
                // Formatear objetos Timestamp de Firebase a una cadena legible (ej. "DD/MM/YYYY HH:MM:SS")
                if (value && typeof value.toDate === 'function') {
                    return value.toDate().toLocaleString('es-DO', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false // Formato 24 horas
                    });
                }
                // Reemplazar valores nulos o indefinidos con una cadena vacía
                if (value === null || value === undefined) {
                    return '';
                }
                // Para asegurar que el texto con comas o comillas dobles no rompa el CSV
                if (typeof value === 'string') {
                    return `"${value.replace(/"/g, '""')}"`; // Escapar comillas dobles y encerrar en comillas
                }
                return value;
            };

            // Generar la fila de encabezados
            const header = columnOrder.map(col => `"${columnTitles[col] || col}"`).join(',');

            // Generar las filas de datos
            const csvRows = data.map(row =>
                columnOrder.map(col => replacer(col, row[col])).join(',')
            );

            // Unir encabezados y filas
            const csv = [header, ...csvRows].join('\r\n');

            // Crear y descargar el archivo Blob
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) { // Asegura compatibilidad con el navegador
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden'; // Oculta el enlace
                document.body.appendChild(link);
                link.click(); // Simula un clic
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Limpia la URL del objeto Blob
            } else {
                alert('Tu navegador no soporta la descarga directa de archivos.');
            }
        }

        // --- Funcionalidad del Modal para Ver Detalles de Encuestas (Formato Tarjeta) ---
        const modal = document.getElementById("surveyDetailModal");
        const viewDetailsBtn = document.getElementById("viewDetailsBtn");
        const closeModalSpan = document.getElementsByClassName("close-button")[0];
        const detailedSurveysContainer = document.getElementById("detailedSurveysContainer");
        const modalTitle = modal.querySelector('h3');

        // Abre el modal para ver todas las encuestas detalladas (las que están filtradas actualmente)
        viewDetailsBtn.onclick = function() {
            modalTitle.textContent = "Encuestas Recibidas a Detalle (Filtradas)";
            modal.style.display = "flex";
            displayDetailedSurveys(filteredSurveysData); // Muestra datos filtrados
        }

        // Cierra el modal al hacer clic en la "x"
        closeModalSpan.onclick = function() {
            modal.style.display = "none";
            detailedSurveysContainer.innerHTML = ''; // Limpia el contenido al cerrar
        }

        // Cierra el modal al hacer clic fuera de él
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                detailedSurveysContainer.innerHTML = ''; // Limpia el contenido al cerrar
            }
        }

        // Función para mostrar encuestas detalladas (puede recibir datos filtrados o todos)
        function displayDetailedSurveys(dataToDisplay) {
            detailedSurveysContainer.innerHTML = ''; // Limpia contenido anterior

            if (!dataToDisplay || dataToDisplay.length === 0) {
                detailedSurveysContainer.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">No hay encuestas para mostrar a detalle con los filtros actuales.</p>';
                return;
            }

            dataToDisplay.forEach((survey, index) => {
                const surveyCard = document.createElement('div');
                surveyCard.classList.add('survey-detail-card');

                const formattedTimestamp = survey.timestamp && survey.timestamp.toDate
                    ? new Date(survey.timestamp.toDate()).toLocaleString('es-DO')
                    : 'N/A';

                // Colores para cada calificación
                const staffColor = getRatingBadgeColor(survey.overall_staff_service);
                const foodColor = getRatingBadgeColor(survey.food_quality);
                const roomColor = getRatingBadgeColor(survey.room_condition);
                const clubColor = getRatingBadgeColor(survey.preferred_club_service);
                const butlerColor = getRatingBadgeColor(survey.butler_service_rating);

                // Mensaje bonito y organizado para WhatsApp
                const whatsappMsg =
                    `📋 *Encuesta #${dataToDisplay.length - index}*%0A` +
                    `🏨 *Habitación:* ${survey.room_number || 'N/A'}%0A` +
                    `🧑‍💼 *Mayordomo:* ${survey.butler || 'N/A'}%0A` +
                    `🕒 *Enviado:* ${formattedTimestamp}%0A%0A` +
                    `⭐ *Servicio General del Personal:* ${survey.overall_staff_service || 'N/A'}%0A` +
                    `🍽️ *Calidad de la Comida:* ${survey.food_quality || 'N/A'}%0A` +
                    `🛏️ *Condición de la Habitación:* ${survey.room_condition || 'N/A'}%0A` +
                    `🏷️ *Servicio Preferred Club:* ${survey.preferred_club_service || 'N/A'}%0A` +
                    `🤵 *Calificación del Mayordomo:* ${survey.butler_service_rating || 'N/A'}%0A%0A` +
                    `💬 *Comentario:*%0A${survey.comments || 'No hay comentarios.'}`;

                surveyCard.innerHTML = `
                    <h4>Encuesta #${dataToDisplay.length - index} (Enviada: ${formattedTimestamp})</h4>
                    <p><strong>Número de Habitación:</strong> ${survey.room_number || 'N/A'}</p>
                    <p><strong>Mayordomo:</strong> ${survey.butler || 'N/A'}</p>
                    <p><strong>Servicio General del Personal:</strong> <span class="rating-value" style="color:${staffColor}; font-weight:700;">${survey.overall_staff_service || 'N/A'}</span></p>
                    <p><strong>Calidad de la Comida:</strong> <span class="rating-value" style="color:${foodColor}; font-weight:700;">${survey.food_quality || 'N/A'}</span></p>
                    <p><strong>Condición de la Habitación:</strong> <span class="rating-value" style="color:${roomColor}; font-weight:700;">${survey.room_condition || 'N/A'}</span></p>
                    <p><strong>Servicio Preferred Club:</strong> <span class="rating-value" style="color:${clubColor}; font-weight:700;">${survey.preferred_club_service || 'N/A'}</span></p>
                    <p><strong>Calificación del Servicio del Mayordomo:</strong> <span class="rating-value" style="color:${butlerColor}; font-weight:700;">${survey.butler_service_rating || 'N/A'}</span></p>
                    <p><strong>Comentarios Adicionales:</strong> ${survey.comments || 'No hay comentarios.'}</p>
                    <button class="whatsapp-survey-btn" 
                        data-msg="${whatsappMsg}"
                        style="background:#25D366; color:#fff; border:none; border-radius:6px; padding:6px 14px; margin-top:8px; cursor:pointer;">
                        <span style="font-size:1.2em; vertical-align:middle;">🟢</span> Enviar a WhatsApp
                    </button>
                `;
                detailedSurveysContainer.appendChild(surveyCard);
            });
        }

        // Función para mostrar un resumen detallado de una métrica específica (utiliza datos filtrados)
        function displayMetricSummary(metricName, metricField, title) {
            modalTitle.textContent = `Resumen Detallado: ${title} (Filtrado)`; // Título dinámico
            detailedSurveysContainer.innerHTML = ''; // Limpia contenido anterior

            if (filteredSurveysData.length === 0) {
                detailedSurveysContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-color);">No hay datos para mostrar el resumen de ${title} con los filtros actuales.</p>`;
                modal.style.display = "flex";
                return;
            }

            const ratingCounts = { "Bad": 0, "Poor": 0, "Regular": 0, "Good": 0, "Excellent": 0 };
            const commentsForMetric = [];

            filteredSurveysData.forEach(survey => {
                const rating = survey[metricField];
                if (rating && ratingCounts.hasOwnProperty(rating)) {
                    ratingCounts[rating]++;
                }
                // Recopila comentarios, pueden ser generales o específicos
                if (survey.comments && survey.comments.trim() !== '') {
                    commentsForMetric.push({
                        comment: survey.comments,
                        ratingForMetric: survey[metricField] || 'N/A', // Calificación específica de esta métrica
                        // Incluye otras calificaciones para contexto
                        overallStaffRating: survey.overall_staff_service || 'N/A',
                        foodQualityRating: survey.food_quality || 'N/A',
                        roomConditionRating: survey.room_condition || 'N/A',
                        preferredClubService: survey.preferred_club_service || 'N/A',
                        butlerServiceRating: survey.butler_service_rating || 'N/A',
                        room: survey.room_number || 'N/A',
                        butler: survey.butler || 'N/A',
                        timestamp: survey.timestamp && survey.timestamp.toDate ? new Date(survey.timestamp.toDate()).toLocaleString('es-DO') : 'N/A'
                    });
                }
            });

            // HTML para la distribución de calificaciones
            let summaryHtml = `<h4>Distribución de Calificaciones para "${title}":</h4>`;
            summaryHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">';
            for (const rating of ["Excellent", "Good", "Regular", "Poor", "Bad"]) {
                const color = getRatingColor(ratingMap[rating]);
                const emoji = getFaceEmoji(ratingMap[rating]);
                summaryHtml += `
                    <div style="text-align: center; background-color: var(--background-color); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <p style="margin: 0; font-size: 1.1em; font-weight: bold; color: ${color};">${emoji} ${rating}</p>
                        <p style="margin: 5px 0 0; font-size: 1.2em; font-weight: bold;">${ratingCounts[rating]}</p>
                    </div>
                `;
            }
            summaryHtml += '</div>';

            // HTML para comentarios relevantes
            summaryHtml += `<h4>Comentarios (pueden ser generales o relacionados):</h4>`;
            if (commentsForMetric.length > 0) {
                commentsForMetric.forEach(c => {
                    summaryHtml += `
                        <div class="comment-card">
                            <p><strong>Comentario:</strong> ${c.comment}</p>
                            <p><small>Calificación (${title}): ${c.ratingForMetric}</small></p>
                            <small>
                                Personal General: ${c.overallStaffRating} | Comida: ${c.foodQualityRating} | Habitación: ${c.roomConditionRating} | Club: ${c.preferredClubService} | Mayordomo: ${c.butlerServiceRating}<br>
                                Habitación: ${c.room} | Mayordomo: ${c.butler} | Enviado: ${c.timestamp}
                            </small>
                        </div>
                    `;
                });
            } else {
                detailedSurveysContainer.innerHTML += '<p style="text-align: center; color: var(--secondary-color);">No hay comentarios disponibles con los filtros actuales.</p>';
            }

            detailedSurveysContainer.innerHTML = summaryHtml;
            modal.style.display = "flex"; // Mostrar el modal
        }

        // --- Funcionalidad del Nuevo Modal de Tabla ---
        const tableModal = document.getElementById("tableModal");
        const viewTableBtn = document.getElementById("viewTableBtn");
        const closeTableModalSpan = document.getElementById("closeTableModal");
        const surveyTableBody = document.getElementById("surveyTableBody");
        const tableSearchInput = document.getElementById("tableSearchInput");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const currentPageSpan = document.getElementById("currentPage");
        const totalPagesSpan = document.getElementById("totalPages");
        const rowsPerPageSelect = document.getElementById("rowsPerPageSelect");

        function renderTable() {
            surveyTableBody.innerHTML = ''; // Limpiar tabla actual

            if (filteredAndSearchedData.length === 0) {
                surveyTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--secondary-color);">No hay encuestas para mostrar en la tabla con la búsqueda actual.</td></tr>';
                currentPageSpan.textContent = 0;
                totalPagesSpan.textContent = 0;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                return;
            }

            // Calcular paginación
            totalPages = Math.ceil(filteredAndSearchedData.length / rowsPerPage);
            currentPage = Math.min(Math.max(1, currentPage), totalPages); // Asegurar que currentPage sea válida

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredAndSearchedData.slice(startIndex, endIndex);

            paginatedData.forEach(survey => {
                const row = surveyTableBody.insertRow();
                const formattedTimestamp = survey.timestamp && survey.timestamp.toDate ? new Date(survey.timestamp.toDate()).toLocaleString('es-DO') : 'N/A';

                row.insertCell().textContent = formattedTimestamp;
                row.insertCell().textContent = survey.room_number || 'N/A';
                row.insertCell().textContent = survey.butler || 'N/A';

                // Calificaciones con color, fondo y tooltip
                function addRatingCell(value) {
                    const cell = row.insertCell();
                    cell.textContent = value || 'N/A';
                    cell.style.color = getRatingBadgeColor(value);
                    cell.style.background = getRatingBadgeBg(value);
                    cell.style.fontWeight = "700";
                    cell.title = value ? ({
                        "Bad": "Muy insatisfecho",
                        "Poor": "Insatisfecho",
                        "Regular": "Regular",
                        "Good": "Satisfecho",
                        "Excellent": "Muy satisfecho"
                    }[value] || value) : "";
                    return cell;
                }
                addRatingCell(survey.overall_staff_service);
                addRatingCell(survey.food_quality);
                addRatingCell(survey.room_condition);
                addRatingCell(survey.preferred_club_service);
                addRatingCell(survey.butler_service_rating);

                row.insertCell().textContent = survey.comments || '';

                // Click en fila para ver detalle
                row.style.cursor = "pointer";
                row.addEventListener('click', () => {
                    // Antes de mostrar el modal de detalle, cierra el de tabla
                    document.getElementById('tableModal').style.display = "none";
                    document.getElementById('surveyDetailModal').style.display = "flex";
                    displayDetailedSurveys([survey]);
                });
            });

            currentPageSpan.textContent = currentPage;
            totalPagesSpan.textContent = totalPages;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
        }

        function applyTableSearch() {
            const searchTerm = tableSearchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
                filteredAndSearchedData = [...filteredSurveysData]; // Restablecer si la búsqueda está vacía
            } else {
                filteredAndSearchedData = filteredSurveysData.filter(survey => {
                    // Busca en todas las columnas relevantes
                    return (survey.room_number && String(survey.room_number).toLowerCase().includes(searchTerm)) ||
                           (survey.butler && survey.butler.toLowerCase().includes(searchTerm)) ||
                           (survey.comments && survey.comments.toLowerCase().includes(searchTerm)) ||
                           (survey.overall_staff_service && survey.overall_staff_service.toLowerCase().includes(searchTerm)) ||
                           (survey.food_quality && survey.food_quality.toLowerCase().includes(searchTerm)) ||
                           (survey.room_condition && survey.room_condition.toLowerCase().includes(searchTerm)) ||
                           (survey.preferred_club_service && survey.preferred_club_service.toLowerCase().includes(searchTerm)) ||
                           (survey.butler_service_rating && survey.butler_service_rating.toLowerCase().includes(searchTerm));
                });
            }
            currentPage = 1; // Reiniciar página al buscar
            renderTable();
        }

        // Eventos para el modal de tabla
        viewTableBtn.onclick = function() {
            tableModal.style.display = "flex";
            // Asegurarse de que el input de búsqueda esté vacío al abrir el modal
            tableSearchInput.value = '';
            // Restablecer los datos de búsqueda a los filtrados actuales
            filteredAndSearchedData = [...filteredSurveysData];
            currentPage = 1; // Reiniciar página
            renderTable();
        }

        closeTableModalSpan.onclick = function() {
            tableModal.style.display = "none";
        }

        tableSearchInput.addEventListener('input', applyTableSearch);

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        rowsPerPageSelect.addEventListener('change', (event) => {
            rowsPerPage = parseInt(event.target.value);
            currentPage = 1; // Reiniciar página al cambiar el número de filas
            renderTable();
        });


        // Cierra el modal de tabla al hacer clic fuera de él (manejar ambos modales)
        window.addEventListener('click', function(event) {
            if (event.target == modal) { // Modal de detalles
                modal.style.display = "none";
                detailedSurveysContainer.innerHTML = '';
            }
            if (event.target == tableModal) { // Modal de tabla
                tableModal.style.display = "none";
            }
        });

        // --- Event Listeners (Controladores de Eventos) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Carga el dashboard inicialmente sin filtros
            loadDashboard();

            // Referencias a los elementos de filtro
            const printReportBtn = document.getElementById('printReportBtn');

            // Event listener para el botón de reintento
            const retryBtn = document.getElementById('retryBtn');
            if (retryBtn) {
                retryBtn.addEventListener('click', () => {
                    loadDashboard();
                });
            }





            // Event listener para el botón "Exportar Reporte (CSV)"
            document.getElementById('exportReportBtn').addEventListener('click', () => {
                if (filteredSurveysData.length > 0) {
                    exportToCsv('secrets_royal_beach_reporte_encuestas_filtrado.csv', filteredSurveysData);
                } else {
                    alert('No hay datos filtrados para exportar. Aplica filtros o asegúrate de tener datos.');
                }
            });

            // Event listener para el botón "Imprimir Reporte"
            printReportBtn.addEventListener('click', () => {
                window.print();
            });

            // Event listeners para las tarjetas de resumen (para abrir el modal con el resumen de la métrica)
            const summaryCards = document.querySelectorAll('.summary-card');
            summaryCards.forEach(card => {
                card.addEventListener('click', () => {
                    const cardId = card.id;
                    let metricField = '';
                    let displayTitle = '';

                    switch (cardId) {
                        case 'totalSurveysCard':
                            viewDetailsBtn.click(); // Abrir modal de detalles
                            return;
                        case 'overallStaffRatingCard':
                            metricField = 'overall_staff_service';
                            displayTitle = 'Servicio General del Personal';
                            break;
                        case 'foodQualityRatingCard':
                            metricField = 'food_quality';
                            displayTitle = 'Calidad de la Comida';
                            break;
                        case 'roomConditionRatingCard':
                            metricField = 'room_condition';
                            displayTitle = 'Condición de la Habitación';
                            break;
                        case 'preferredClubRatingCard':
                            metricField = 'preferred_club_service';
                            displayTitle = 'Servicio Preferred Club';
                            break;
                        case 'butlerServiceRatingCard':
                            metricField = 'butler_service_rating';
                            displayTitle = 'Calificación del Servicio del Mayordomo';
                            break;
                        default:
                            console.warn('Tarjeta de resumen desconocida clicada:', cardId);
                            return;
                    }
                    displayMetricSummary(cardId, metricField, displayTitle);
                });
            });



            function filterByRange(data, start, end) {
                return data.filter(s => {
                    const d = s.timestamp ? new Date(s.timestamp.toDate ? s.timestamp.toDate() : s.timestamp) : null;
                    if (!d) return false;
                    const iso = d.toISOString().slice(0,10);
                    return iso >= start && iso <= end;
                });
            }



            // Event listeners para el botón de copiar comentario
            document.addEventListener('click', function(event) {
                const whatsappButton = event.target.closest('.whatsapp-comment-btn');
                if (whatsappButton) {
                    const comment = whatsappButton.dataset.comment;
                    const room = whatsappButton.dataset.room;
                    const butler = whatsappButton.dataset.butler;
                    const date = whatsappButton.dataset.date;
                    // Mensaje completo en el formato solicitado
                    const message = `${decodeURIComponent(comment)}\n\nHabitación: ${decodeURIComponent(room)} - Mayordomo: ${decodeURIComponent(butler)} - Enviado: ${decodeURIComponent(date)}`;
                    const phone = ""; // Si quieres un número fijo, ponlo aquí. Si no, deja vacío.
                    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                    window.open(url, '_blank');
                }
                const whatsappSurveyBtn = event.target.closest('.whatsapp-survey-btn');
                if (whatsappSurveyBtn) {
                    const msg = whatsappSurveyBtn.dataset.msg;
                    const phone = ""; // Si quieres un número fijo, ponlo aquí. Si no, deja vacío.
                    const url = `https://wa.me/${phone}?text=${msg}`;
                    window.open(url, '_blank');
                }
            });

            const topButlersBtn = document.getElementById('topButlersBtn');
            const topButlersModal = document.getElementById('topButlersModal');
            const closeTopButlersModal = document.getElementById('closeTopButlersModal');
            const topButlersCards = document.getElementById('topButlersCards');
            const topButlersList = document.getElementById('topButlersList');
            const sendTopButlersWhatsappBtn = document.getElementById('sendTopButlersWhatsappBtn');

            function showTopButlers() {
                // Cuenta menciones de mayordomos en los datos filtrados
                const butlerCounts = {};
                filteredSurveysData.forEach(s => {
                    if (s.butler && s.butler.trim() !== '') {
                        const name = s.butler.trim();
                        butlerCounts[name] = (butlerCounts[name] || 0) + 1;
                    }
                });
                // Ordena por menciones descendente
                const sorted = Object.entries(butlerCounts).sort((a, b) => b[1] - a[1]);
                // Top 10
                const top10 = sorted.slice(0, 10);
                // Cartas para los 3 primeros
                topButlersCards.innerHTML = '';
                const medals = ['🥇', '🥈', '🥉'];
                for (let i = 0; i < 3 && i < top10.length; i++) {
                    const [name, count] = top10[i];
                    const card = document.createElement('div');
                    card.className = 'top-butler-card';
                    card.innerHTML = `
                        <div class="top-butler-medal">${medals[i]}</div>
                        <div class="top-butler-avatar">${name[0] ? name[0].toUpperCase() : '?'}</div>
                        <div class="top-butler-name">${name}</div>
                        <div class="top-butler-count">${count} menciones</div>
                    `;
                    topButlersCards.appendChild(card);
                }
                // Listado del top 10 con barra de progreso
                topButlersList.innerHTML = '';
                const maxCount = top10.length > 0 ? top10[0][1] : 1;
                top10.forEach(([name, count], idx) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="top-butler-rank">${idx+1}</span>
                        <span class="top-butler-list-name">${name}</span>
                        <div class="top-butler-bar"><div class="top-butler-bar-inner" style="width:${(count/maxCount*100).toFixed(0)}%"></div></div>
                        <span class="top-butler-list-count">${count}</span>
                    `;
                    if (idx < 3) li.style.background = '#fffbe6';
                    topButlersList.appendChild(li);
                });
                // Habilita el botón de WhatsApp solo si hay datos
                sendTopButlersWhatsappBtn.style.display = top10.length > 0 ? 'block' : 'none';
                sendTopButlersWhatsappBtn.onclick = function() {
                    if (top10.length === 0) return;
                    let msg = '🏆 *Top 10 Mayordomos Más Mencionados* 🏆%0A%0A';
                    top10.forEach(([name, count], idx) => {
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `${idx+1}°`;
                        msg += `${medal} ${name}: ${count} menciones%0A`;
                    });
                    const phone = '';
                    const url = `https://wa.me/${phone}?text=${msg}`;
                    window.open(url, '_blank');
                };
                topButlersModal.style.display = 'flex';
            }
            topButlersBtn.addEventListener('click', showTopButlers);
            closeTopButlersModal.addEventListener('click', () => {
                topButlersModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == topButlersModal) {
                    topButlersModal.style.display = 'none';
                }
            });

            const butlerEffectivenessBtn = document.getElementById('butlerEffectivenessBtn');
            const butlerEffectivenessModal = document.getElementById('butlerEffectivenessModal');
            const closeButlerEffectivenessModal = document.getElementById('closeButlerEffectivenessModal');
            const butlerEffectivenessList = document.getElementById('butlerEffectivenessList');

            function showButlerEffectiveness() {
                // Calcula NPS (Net Promoter Score) para el servicio del mayordomo
                const butlerStats = {};
                
                // Recolectar datos de calificaciones del servicio del mayordomo
                filteredSurveysData.forEach(s => {
                    if (s.butler && s.butler_service_rating) {
                        const name = s.butler.trim();
                        if (!butlerStats[name]) {
                            butlerStats[name] = { 
                                totalSurveys: 0,
                                promoters: 0,    // Good, Excellent
                                passives: 0,     // Regular
                                detractors: 0    // Bad, Poor
                            };
                        }
                        
                        butlerStats[name].totalSurveys++;
                        
                        // Clasificar según la calificación de texto
                        const rating = s.butler_service_rating;
                        if (rating === "Good" || rating === "Excellent") {
                            butlerStats[name].promoters++;
                        } else if (rating === "Regular") {
                            butlerStats[name].passives++;
                        } else if (rating === "Bad" || rating === "Poor") {
                            butlerStats[name].detractors++;
                        }
                    }
                });
                
                // Calcular NPS para cada mayordomo
                const maxSurveys = Math.max(...Object.values(butlerStats).map(stat => stat.totalSurveys));
                const effectiveness = Object.entries(butlerStats)
                    .map(([name, stat]) => {
                        // Calcular NPS básico
                        const promoterPercentage = stat.totalSurveys > 0 ? (stat.promoters / stat.totalSurveys) * 100 : 0;
                        const detractorPercentage = stat.totalSurveys > 0 ? (stat.detractors / stat.totalSurveys) * 100 : 0;
                        const npsScore = promoterPercentage - detractorPercentage;
                        
                        // Score final: NPS (sin factor de confianza)
                        const finalScore = npsScore;
                        
                        return {
                            name,
                            npsScore: npsScore,
                            finalScore: finalScore,
                            totalSurveys: stat.totalSurveys,
                            promoters: stat.promoters,
                            passives: stat.passives,
                            detractors: stat.detractors
                        };
                    })
                    .filter(b => b.totalSurveys > 0)
                    .sort((a, b) => {
                        // Primero ordenar por NPS (de mayor a menor)
                        if (b.finalScore !== a.finalScore) {
                            return b.finalScore - a.finalScore;
                        }
                        // Si tienen el mismo NPS, ordenar por cantidad de encuestas (de mayor a menor)
                        return b.totalSurveys - a.totalSurveys;
                    });
                
                // Renderiza lista
                butlerEffectivenessList.innerHTML = '';
                effectiveness.forEach((b, idx) => {
                    let nivel = 'media', badge = 'Media';
                    if (b.finalScore >= 25) { nivel = 'alta'; badge = 'Alta'; }
                    else if (b.finalScore < 0) { nivel = 'baja'; badge = 'Baja'; }
                    
                    const li = document.createElement('li');
                    li.className = nivel;
                    
                    // Barra de progreso: NPS -100 a +100 mapeado a 0-100%
                    const barWidth = ((b.npsScore + 100) / 200 * 100).toFixed(0);
                    
                    li.innerHTML = `
                        <span class="butler-effectiveness-rank">${idx+1}</span>
                        <span class="butler-effectiveness-avatar">${b.name[0] ? b.name[0].toUpperCase() : '?'}</span>
                        <span class="butler-effectiveness-name">${b.name}</span>
                        <span class="butler-effectiveness-avg">${b.npsScore.toFixed(1)}</span>
                    <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 2px;">
                        Score: ${b.finalScore.toFixed(1)}
                    </small>
                        <div class="butler-effectiveness-bar"><div class="butler-effectiveness-bar-inner" style="width:${barWidth}%"></div></div>
                        <span class="butler-effectiveness-badge ${nivel}">${badge}</span>
                        <span style="color:#888; font-size:0.9rem; margin-left:8px;">
                            📊 ${b.totalSurveys} encuestas | 👍 ${b.promoters}P | 😐 ${b.passives}Pas | 👎 ${b.detractors}D
                        </span>
                    `;
                    
                    // Agregar evento click para mostrar detalle
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', () => showButlerDetail(b));
                    
                    butlerEffectivenessList.appendChild(li);
                });
                butlerEffectivenessModal.style.display = 'flex';
            }
            butlerEffectivenessBtn.addEventListener('click', showButlerEffectiveness);
            closeButlerEffectivenessModal.addEventListener('click', () => {
                butlerEffectivenessModal.style.display = 'none';
            });
            window.addEventListener('click', function(event) {
                if (event.target == butlerEffectivenessModal) {
                    butlerEffectivenessModal.style.display = 'none';
                }
            });

            // --- Funcionalidad del Modal de Email ---
            const emailReportBtn = document.getElementById('emailReportBtn');
            const emailReportModal = document.getElementById('emailReportModal');
            const closeEmailReportModal = document.getElementById('closeEmailReportModal');
            const sendEmailBtn = document.getElementById('sendEmailBtn');
            const previewEmailBtn = document.getElementById('previewEmailBtn');
            const saveEmailTemplateBtn = document.getElementById('saveEmailTemplateBtn');

            // Función para actualizar la vista previa del reporte
            function updateEmailPreview() {
                const totalSurveys = filteredSurveysData.length;
                const startDate = document.getElementById('modalStartDate') ? document.getElementById('modalStartDate').value : '';
                const endDate = document.getElementById('modalEndDate') ? document.getElementById('modalEndDate').value : '';
                const butlerFilter = document.getElementById('modalButlerFilter') ? document.getElementById('modalButlerFilter').value : '';

                document.getElementById('previewTotalSurveys').textContent = totalSurveys;

                let period = 'Todos los datos';
                if (startDate && endDate) {
                    period = `Del ${startDate} al ${endDate}`;
                } else if (startDate) {
                    period = `Desde ${startDate}`;
                } else if (endDate) {
                    period = `Hasta ${endDate}`;
                }
                document.getElementById('previewPeriod').textContent = period;

                let filters = 'Ninguno';
                if (butlerFilter) {
                    filters = `Mayordomo: ${butlerFilter}`;
                }
                document.getElementById('previewFilters').textContent = filters;
            }

            // Función para generar el contenido del reporte mejorado
            function generateEmailReport() {
                const reportType = document.getElementById('emailReportType').value;
                const includeChart = document.getElementById('emailIncludeChart').checked;
                const includeComments = document.getElementById('emailIncludeComments').checked;
                const customMessage = document.getElementById('emailMessage').value;

                let reportContent = `
                    <h2>📊 Reporte de Satisfacción - Secrets Royal Beach</h2>
                    <p><strong>Fecha de generación:</strong> ${new Date().toLocaleString('es-DO')}</p>
                    <p><strong>Total de encuestas:</strong> ${filteredSurveysData.length}</p>
                    <p><strong>Período analizado:</strong> ${getDateRange()}</p>
                `;

                // Agregar mensaje personalizado
                if (customMessage) {
                    reportContent += `<p><strong>Mensaje:</strong> ${customMessage}</p>`;
                }

                // === ANÁLISIS DETALLADO DE RESULTADOS ===
                reportContent += generateDetailedAnalysis();

                // === GRÁFICAS Y ESTADÍSTICAS ===
                if (includeChart) {
                    reportContent += generateChartSection();
                }

                // === COMENTARIOS CON PUNTUACIONES BAJAS ===
                reportContent += generateLowRatingCommentsSection();

                // === RECOMENDACIONES DE MEJORA ===
                reportContent += generateRecommendationsSection();

                // === COMENTARIOS GENERALES ===
                if (includeComments) {
                    reportContent += generateGeneralCommentsSection();
                }

                return reportContent;
            }

            // Función para obtener el rango de fechas
            function getDateRange() {
                if (filteredSurveysData.length === 0) return 'Sin datos';
                
                const dates = filteredSurveysData
                    .map(s => s.timestamp ? (s.timestamp.toDate ? s.timestamp.toDate() : new Date(s.timestamp)) : null)
                    .filter(d => d)
                    .sort((a, b) => a - b);
                
                if (dates.length === 0) return 'Sin fechas válidas';
                
                const startDate = dates[0].toLocaleDateString('es-DO');
                const endDate = dates[dates.length - 1].toLocaleDateString('es-DO');
                
                return startDate === endDate ? startDate : `${startDate} - ${endDate}`;
            }

            // Función para generar análisis detallado
            function generateDetailedAnalysis() {
                const fieldsToAverage = [
                    { fieldName: 'overall_staff_service', title: 'Servicio General del Personal', icon: '👥' },
                    { fieldName: 'food_quality', title: 'Calidad de la Comida', icon: '🍽️' },
                    { fieldName: 'room_condition', title: 'Condición de la Habitación', icon: '🏠' },
                    { fieldName: 'preferred_club_service', title: 'Servicio Preferred Club', icon: '⭐' },
                    { fieldName: 'butler_service_rating', title: 'Calificación del Servicio del Mayordomo', icon: '👔' }
                ];

                let analysis = `
                    <h3>📈 Análisis Detallado de Resultados</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                `;

                fieldsToAverage.forEach(item => {
                    const avg = calculateAverage(filteredSurveysData, item.fieldName);
                    const emoji = getFaceEmoji(avg);
                    const color = getRatingColor(avg);
                    const distribution = getRatingDistribution(filteredSurveysData, item.fieldName);
                    const trend = getTrendAnalysis(filteredSurveysData, item.fieldName);
                    
                    analysis += `
                        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${color};">
                            <h4 style="margin: 0 0 10px 0; color: ${color};">${item.icon} ${item.title}</h4>
                            <p style="font-size: 1.2em; margin: 5px 0;"><strong>Calificación Promedio:</strong> ${emoji} ${avg}</p>
                            <p style="margin: 5px 0;"><strong>Distribución:</strong> ${distribution}</p>
                            <p style="margin: 5px 0;"><strong>Tendencia:</strong> ${trend}</p>
                        </div>
                    `;
                });

                analysis += '</div>';
                return analysis;
            }

            // Función para obtener distribución de calificaciones
            function getRatingDistribution(data, field) {
                const ratings = { 'Bad': 0, 'Poor': 0, 'Regular': 0, 'Good': 0, 'Excellent': 0 };
                data.forEach(survey => {
                    const rating = survey[field];
                    if (rating && ratings.hasOwnProperty(rating)) {
                        ratings[rating]++;
                    }
                });

                const total = data.length;
                if (total === 0) return 'Sin datos';

                return Object.entries(ratings)
                    .map(([rating, count]) => `${rating}: ${count} (${((count/total)*100).toFixed(1)}%)`)
                    .join(' | ');
            }

            // Función para análisis de tendencias
            function getTrendAnalysis(data, field) {
                if (data.length < 2) return 'Insuficientes datos para análisis de tendencia';

                const sortedData = data
                    .map(s => ({
                        rating: s[field],
                        date: s.timestamp ? (s.timestamp.toDate ? s.timestamp.toDate() : new Date(s.timestamp)) : null
                    }))
                    .filter(s => s.date && s.rating)
                    .sort((a, b) => a.date - b.date);

                if (sortedData.length < 2) return 'Datos insuficientes';

                const midPoint = Math.floor(sortedData.length / 2);
                const firstHalf = sortedData.slice(0, midPoint);
                const secondHalf = sortedData.slice(midPoint);

                const avgFirst = getNumericAverage(firstHalf.map(s => s.rating), 'rating');
                const avgSecond = getNumericAverage(secondHalf.map(s => s.rating), 'rating');

                if (avgSecond > avgFirst + 0.5) return '📈 Mejorando';
                if (avgSecond < avgFirst - 0.5) return '📉 Deteriorando';
                return '➡️ Estable';
            }

            // Función para generar sección de gráficas
            function generateChartSection() {
                return `
                    <h3>📊 Distribución de Calificaciones</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p><strong>Nota:</strong> Las gráficas detalladas se incluyen como archivos adjuntos o se pueden generar desde el dashboard.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                            ${generateChartSummary()}
                        </div>
                    </div>
                `;
            }

            // Función para generar resumen de gráficas
            function generateChartSummary() {
                const fields = [
                    { field: 'overall_staff_service', title: 'Personal', icon: '👥' },
                    { field: 'food_quality', title: 'Comida', icon: '🍽️' },
                    { field: 'room_condition', title: 'Habitación', icon: '🏠' },
                    { field: 'preferred_club_service', title: 'Club', icon: '⭐' },
                    { field: 'butler_service_rating', title: 'Mayordomo', icon: '👔' }
                ];

                return fields.map(item => {
                    const distribution = getRatingDistribution(filteredSurveysData, item.field);
                    const avg = calculateAverage(filteredSurveysData, item.field);
                    const color = getRatingColor(avg);
                    
                    return `
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid ${color};">
                            <h4 style="margin: 0 0 10px 0; color: ${color};">${item.icon} ${item.title}</h4>
                            <p style="margin: 5px 0;"><strong>Promedio:</strong> ${avg}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;">${distribution}</p>
                        </div>
                    `;
                }).join('');
            }

            // Función para generar sección de comentarios con puntuaciones bajas
            function generateLowRatingCommentsSection() {
                const lowRatingComments = filteredSurveysData.filter(survey => {
                    if (!survey.comments || survey.comments.trim() === '') return false;
                    
                    // Verificar si tiene alguna calificación baja (Bad, Poor, Regular)
                    const ratings = [
                        survey.overall_staff_service,
                        survey.food_quality,
                        survey.room_condition,
                        survey.preferred_club_service,
                        survey.butler_service_rating
                    ];
                    
                    return ratings.some(rating => ['Bad', 'Poor', 'Regular'].includes(rating));
                });

                if (lowRatingComments.length === 0) {
                    return `
                        <h3>✅ Comentarios con Puntuaciones Bajas</h3>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0; color: #2d5a2d;"><strong>¡Excelente!</strong> No se encontraron comentarios con puntuaciones bajas en este período.</p>
                        </div>
                    `;
                }

                let section = `
                    <h3>⚠️ Comentarios con Puntuaciones Bajas - Áreas de Mejora</h3>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <p style="margin: 0 0 15px 0; color: #856404;"><strong>Se encontraron ${lowRatingComments.length} comentarios con puntuaciones bajas que requieren atención inmediata.</strong></p>
                `;

                // Agrupar por tipo de problema
                const problemCategories = {
                    'Servicio General': [],
                    'Calidad de Comida': [],
                    'Condición de Habitación': [],
                    'Servicio Preferred Club': [],
                    'Servicio de Mayordomo': [],
                    'Múltiples Problemas': []
                };

                lowRatingComments.forEach(comment => {
                    const lowRatings = [];
                    if (['Bad', 'Poor', 'Regular'].includes(comment.overall_staff_service)) {
                        lowRatings.push('Servicio General');
                    }
                    if (['Bad', 'Poor', 'Regular'].includes(comment.food_quality)) {
                        lowRatings.push('Calidad de Comida');
                    }
                    if (['Bad', 'Poor', 'Regular'].includes(comment.room_condition)) {
                        lowRatings.push('Condición de Habitación');
                    }
                    if (['Bad', 'Poor', 'Regular'].includes(comment.preferred_club_service)) {
                        lowRatings.push('Servicio Preferred Club');
                    }
                    if (['Bad', 'Poor', 'Regular'].includes(comment.butler_service_rating)) {
                        lowRatings.push('Servicio de Mayordomo');
                    }

                    if (lowRatings.length > 1) {
                        problemCategories['Múltiples Problemas'].push({ comment, lowRatings });
                    } else if (lowRatings.length === 1) {
                        problemCategories[lowRatings[0]].push({ comment, lowRatings });
                    }
                });

                // Mostrar comentarios por categoría
                Object.entries(problemCategories).forEach(([category, comments]) => {
                    if (comments.length > 0) {
                        section += `
                            <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                                <h4 style="margin: 0 0 15px 0; color: #dc3545;">🚨 ${category} (${comments.length} casos)</h4>
                        `;

                        comments.forEach(({ comment, lowRatings }) => {
                            const timestamp = comment.timestamp && comment.timestamp.toDate 
                                ? new Date(comment.timestamp.toDate()).toLocaleString('es-DO')
                                : 'N/A';
                            
                            section += `
                                <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #dc3545;">
                                    <p style="margin: 5px 0;"><strong>Comentario:</strong> ${comment.comments}</p>
                                    <p style="margin: 5px 0; font-size: 0.9em;"><strong>Problemas identificados:</strong> ${lowRatings.join(', ')}</p>
                                    <p style="margin: 5px 0; font-size: 0.9em;"><strong>Habitación:</strong> ${comment.room_number || 'N/A'} | <strong>Mayordomo:</strong> ${comment.butler || 'N/A'}</p>
                                    <p style="margin: 5px 0; font-size: 0.9em;"><strong>Fecha:</strong> ${timestamp}</p>
                                    <div style="margin: 5px 0; font-size: 0.9em;">
                                        <strong>Calificaciones:</strong> 
                                        Personal: ${comment.overall_staff_service || 'N/A'} | 
                                        Comida: ${comment.food_quality || 'N/A'} | 
                                        Habitación: ${comment.room_condition || 'N/A'} | 
                                        Club: ${comment.preferred_club_service || 'N/A'} | 
                                        Mayordomo: ${comment.butler_service_rating || 'N/A'}
                                    </div>
                                </div>
                            `;
                        });

                        section += '</div>';
                    }
                });

                section += '</div>';
                return section;
            }

            // Función para generar recomendaciones
            function generateRecommendationsSection() {
                const recommendations = [];
                
                // Analizar cada área y generar recomendaciones
                const fields = [
                    { field: 'overall_staff_service', title: 'Servicio General del Personal', icon: '👥' },
                    { field: 'food_quality', title: 'Calidad de la Comida', icon: '🍽️' },
                    { field: 'room_condition', title: 'Condición de la Habitación', icon: '🏠' },
                    { field: 'preferred_club_service', title: 'Servicio Preferred Club', icon: '⭐' },
                    { field: 'butler_service_rating', title: 'Servicio de Mayordomo', icon: '👔' }
                ];

                fields.forEach(item => {
                    const avg = calculateAverage(filteredSurveysData, item.field);
                    const distribution = getRatingDistribution(filteredSurveysData, item.field);
                    const lowRatings = filteredSurveysData.filter(s => ['Bad', 'Poor', 'Regular'].includes(s[item.field])).length;
                    
                    if (lowRatings > 0) {
                        const percentage = ((lowRatings / filteredSurveysData.length) * 100).toFixed(1);
                        recommendations.push({
                            area: item.title,
                            icon: item.icon,
                            priority: lowRatings > 5 ? 'ALTA' : lowRatings > 2 ? 'MEDIA' : 'BAJA',
                            description: `${percentage}% de calificaciones bajas (${lowRatings} casos)`,
                            suggestions: getSuggestionsForArea(item.field, lowRatings)
                        });
                    }
                });

                if (recommendations.length === 0) {
                    return `
                        <h3>🎯 Recomendaciones de Mejora</h3>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0; color: #2d5a2d;"><strong>¡Excelente trabajo!</strong> No se identificaron áreas críticas que requieran mejora inmediata.</p>
                        </div>
                    `;
                }

                // Ordenar por prioridad
                recommendations.sort((a, b) => {
                    const priorityOrder = { 'ALTA': 3, 'MEDIA': 2, 'BAJA': 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });

                let section = `
                    <h3>🎯 Recomendaciones de Mejora - Plan de Acción</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="margin: 0 0 15px 0;"><strong>Prioridades identificadas basadas en el análisis de comentarios y calificaciones:</strong></p>
                `;

                recommendations.forEach((rec, index) => {
                    const priorityColor = rec.priority === 'ALTA' ? '#dc3545' : rec.priority === 'MEDIA' ? '#ffc107' : '#28a745';
                    
                    section += `
                        <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${priorityColor};">
                            <h4 style="margin: 0 0 10px 0; color: ${priorityColor};">${index + 1}. ${rec.icon} ${rec.area}</h4>
                            <p style="margin: 5px 0;"><strong>Prioridad:</strong> <span style="color: ${priorityColor}; font-weight: bold;">${rec.priority}</span></p>
                            <p style="margin: 5px 0;"><strong>Problema:</strong> ${rec.description}</p>
                            <div style="margin: 10px 0;">
                                <strong>Acciones sugeridas:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    <li>Se le dará seguimiento</li>
                                </ul>
                            </div>
                        </div>
                    `;
                });

                section += '</div>';
                return section;
            }

            // Función para obtener sugerencias por área
            function getSuggestionsForArea(field, lowRatingCount) {
                const suggestions = {
                    'overall_staff_service': [
                        'Implementar programa de capacitación para el personal',
                        'Revisar protocolos de atención al cliente',
                        'Establecer sistema de feedback interno',
                        'Realizar encuestas de satisfacción del personal'
                    ],
                    'food_quality': [
                        'Revisar menús y variedad de opciones',
                        'Capacitar al personal de cocina',
                        'Mejorar control de calidad de ingredientes',
                        'Implementar sistema de feedback de cocina'
                    ],
                    'room_condition': [
                        'Programar mantenimiento preventivo',
                        'Actualizar mobiliario y decoración',
                        'Mejorar protocolos de limpieza',
                        'Implementar checklist de inspección'
                    ],
                    'preferred_club_service': [
                        'Revisar beneficios del Preferred Club',
                        'Capacitar personal especializado',
                        'Mejorar comunicación de servicios exclusivos',
                        'Implementar sistema de reservas prioritarias'
                    ],
                    'butler_service_rating': [
                        'Capacitar mayordomos en atención personalizada',
                        'Implementar sistema de asignación inteligente',
                        'Establecer protocolos de seguimiento',
                        'Mejorar comunicación entre mayordomos y huéspedes'
                    ]
                };

                return suggestions[field] || ['Revisar procesos internos', 'Implementar mejoras específicas'];
            }

            // Función para generar sección de comentarios generales
            function generateGeneralCommentsSection() {
                const comments = filteredSurveysData.filter(s => s.comments && s.comments.trim() !== '');
                
                if (comments.length === 0) {
                    return `
                        <h3>💬 Comentarios Generales</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="margin: 0; color: #6c757d;">No hay comentarios adicionales en este período.</p>
                        </div>
                    `;
                }

                let section = `
                    <h3>💬 Comentarios Generales</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="margin: 0 0 15px 0;"><strong>Total de comentarios:</strong> ${comments.length}</p>
                `;

                comments.slice(0, 15).forEach(comment => {
                    const timestamp = comment.timestamp && comment.timestamp.toDate 
                        ? new Date(comment.timestamp.toDate()).toLocaleString('es-DO')
                        : 'N/A';
                    
                    section += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                            <p style="margin: 5px 0;"><strong>Comentario:</strong> ${comment.comments}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Habitación:</strong> ${comment.room_number || 'N/A'} | <strong>Mayordomo:</strong> ${comment.butler || 'N/A'}</p>
                            <p style="margin: 5px 0; font-size: 0.9em;"><strong>Fecha:</strong> ${timestamp}</p>
                        </div>
                    `;
                });

                if (comments.length > 15) {
                    section += `<p style="margin: 10px 0; font-style: italic; color: #6c757d;">... y ${comments.length - 15} comentarios adicionales.</p>`;
                }

                section += '</div>';
                return section;
            }

            // Función para enviar el reporte por email mejorado
            function sendEmailReport() {
                const recipient = document.getElementById('emailRecipient').value;
                const subject = document.getElementById('emailSubject').value;
                const includeChart = document.getElementById('emailIncludeChart').checked;
                
                if (!recipient) {
                    alert('Por favor, ingresa al menos un destinatario.');
                    return;
                }

                if (!subject) {
                    alert('Por favor, ingresa un asunto para el email.');
                    return;
                }

                // Generar reporte con gráficas si está seleccionado
                let reportContent = generateEmailReport();
                
                // Si incluye gráficas, agregar instrucciones para adjuntar
                if (includeChart) {
                    reportContent += `
                        
                        <h3>📊 Gráficas Detalladas</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p><strong>Nota importante:</strong> Para obtener las gráficas detalladas en alta calidad:</p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Abre el dashboard en tu navegador</li>
                                <li>Haz clic derecho en la gráfica de "Distribución de Calificaciones"</li>
                                <li>Selecciona "Guardar imagen como..."</li>
                                <li>Adjunta la imagen a este email</li>
                            </ol>
                            <p style="color: #666; font-style: italic;">Alternativamente, puedes hacer una captura de pantalla del dashboard completo.</p>
                        </div>
                    `;
                }

                // Agregar instrucciones de formato
                reportContent += `
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 Instrucciones para el Reporte</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Este reporte incluye análisis detallado de satisfacción del cliente</li>
                            <li>Las áreas con puntuaciones bajas están marcadas con prioridad</li>
                            <li>Se incluyen recomendaciones específicas de mejora</li>
                            <li>Los comentarios críticos están categorizados por tipo de problema</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="margin: 0 0 10px 0; color: #f57c00;">🎯 Próximos Pasos Sugeridos</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li>Revisar las áreas de prioridad ALTA identificadas</li>
                            <li>Implementar las acciones sugeridas en el plan de mejora</li>
                            <li>Programar seguimiento en 2-4 semanas</li>
                            <li>Compartir este reporte con el equipo correspondiente</li>
                        </ol>
                    </div>
                    
                    <p style="text-align: center; color: #666; font-style: italic; margin-top: 30px;">
                        ---<br>
                        Reporte generado automáticamente por el Sistema de Satisfacción del Cliente<br>
                        Secrets Royal Beach - ${new Date().toLocaleDateString('es-DO')}
                    </p>
                `;

                // Crear el enlace mailto con el contenido del reporte
                const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(reportContent)}`;
                
                // Abrir el cliente de email predeterminado
                window.open(mailtoLink);
                
                // Cerrar el modal
                emailReportModal.style.display = 'none';
                
                // Mostrar mensaje de confirmación mejorado
                const confirmationMessage = includeChart 
                    ? 'Se ha abierto tu cliente de email con el reporte completo. Recuerda adjuntar las gráficas del dashboard para mejor visualización.'
                    : 'Se ha abierto tu cliente de email con el reporte preparado. Revisa y envía el email.';
                
                alert(confirmationMessage);
            }

            // Función para mostrar vista previa mejorada
            function showEmailPreview() {
                const reportContent = generateEmailReport();
                const includeChart = document.getElementById('emailIncludeChart').checked;
                
                let fullContent = reportContent;
                
                // Si incluye gráficas, agregar instrucciones
                if (includeChart) {
                    fullContent += `
                        <h3>📊 Gráficas Detalladas</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p><strong>Nota importante:</strong> Para obtener las gráficas detalladas en alta calidad:</p>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>Abre el dashboard en tu navegador</li>
                                <li>Haz clic derecho en la gráfica de "Distribución de Calificaciones"</li>
                                <li>Selecciona "Guardar imagen como..."</li>
                                <li>Adjunta la imagen a este email</li>
                            </ol>
                            <p style="color: #666; font-style: italic;">Alternativamente, puedes hacer una captura de pantalla del dashboard completo.</p>
                        </div>
                    `;
                }

                // Agregar instrucciones y formato final
                fullContent += `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 Instrucciones para el Reporte</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Este reporte incluye análisis detallado de satisfacción del cliente</li>
                            <li>Las áreas con puntuaciones bajas están marcadas con prioridad</li>
                            <li>Se incluyen recomendaciones específicas de mejora</li>
                            <li>Los comentarios críticos están categorizados por tipo de problema</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <h4 style="margin: 0 0 10px 0; color: #f57c00;">🎯 Próximos Pasos Sugeridos</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            <li>Revisar las áreas de prioridad ALTA identificadas</li>
                            <li>Implementar las acciones sugeridas en el plan de mejora</li>
                            <li>Programar seguimiento en 2-4 semanas</li>
                            <li>Compartir este reporte con el equipo correspondiente</li>
                        </ol>
                    </div>
                    
                    <p style="text-align: center; color: #666; font-style: italic; margin-top: 30px;">
                        ---<br>
                        Reporte generado automáticamente por el Sistema de Satisfacción del Cliente<br>
                        Secrets Royal Beach - ${new Date().toLocaleDateString('es-DO')}
                    </p>
                `;

                const previewWindow = window.open('', '_blank', 'width=1000,height=800');
                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Vista Previa del Reporte - Secrets Royal Beach</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                line-height: 1.6; 
                                background: #f5f5f5;
                                color: #333;
                            }
                            .container {
                                max-width: 900px;
                                margin: 0 auto;
                                background: white;
                                padding: 30px;
                                border-radius: 10px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            }
                            h2, h3, h4 { 
                                color: #2c3e50; 
                                margin-top: 30px;
                                margin-bottom: 15px;
                            }
                            h2 { 
                                border-bottom: 3px solid #3498db; 
                                padding-bottom: 10px;
                                font-size: 1.8em;
                            }
                            h3 { 
                                color: #2980b9; 
                                font-size: 1.4em;
                            }
                            h4 { 
                                color: #34495e; 
                                font-size: 1.2em;
                            }
                            ul, ol { 
                                padding-left: 25px; 
                                margin: 10px 0;
                            }
                            li { 
                                margin-bottom: 8px; 
                                line-height: 1.5;
                            }
                            small { 
                                color: #7f8c8d; 
                                font-size: 0.9em;
                            }
                            .highlight {
                                background: #ecf0f1;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #3498db;
                                margin: 15px 0;
                            }
                            .warning {
                                background: #fff3cd;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #ffc107;
                                margin: 15px 0;
                            }
                            .success {
                                background: #d4edda;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #28a745;
                                margin: 15px 0;
                            }
                            .info {
                                background: #d1ecf1;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #17a2b8;
                                margin: 15px 0;
                            }
                            .footer {
                                text-align: center;
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 1px solid #ecf0f1;
                                color: #7f8c8d;
                                font-style: italic;
                            }
                            @media print {
                                body { background: white; }
                                .container { box-shadow: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            ${fullContent}
                        </div>
                    </body>
                    </html>
                `);
                previewWindow.document.close();
            }

            // Función para guardar plantilla
            function saveEmailTemplate() {
                const template = {
                    recipient: document.getElementById('emailRecipient').value,
                    subject: document.getElementById('emailSubject').value,
                    message: document.getElementById('emailMessage').value,
                    reportType: document.getElementById('emailReportType').value,
                    frequency: document.getElementById('emailFrequency').value,
                    includeChart: document.getElementById('emailIncludeChart').checked,
                    includeComments: document.getElementById('emailIncludeComments').checked
                };

                localStorage.setItem('emailTemplate', JSON.stringify(template));
                alert('Plantilla guardada exitosamente.');
            }

            // Función para cargar plantilla guardada
            function loadEmailTemplate() {
                const savedTemplate = localStorage.getItem('emailTemplate');
                if (savedTemplate) {
                    const template = JSON.parse(savedTemplate);
                    document.getElementById('emailRecipient').value = template.recipient || '';
                    document.getElementById('emailSubject').value = template.subject || '';
                    document.getElementById('emailMessage').value = template.message || '';
                    document.getElementById('emailReportType').value = template.reportType || 'summary';
                    document.getElementById('emailFrequency').value = template.frequency || 'once';
                    document.getElementById('emailIncludeChart').checked = template.includeChart || false;
                    document.getElementById('emailIncludeComments').checked = template.includeComments || false;
                }
            }

            // Event listeners para el modal de email
            emailReportBtn.addEventListener('click', () => {
                emailReportModal.style.display = 'flex';
                updateEmailPreview();
                loadEmailTemplate();
            });

            closeEmailReportModal.addEventListener('click', () => {
                emailReportModal.style.display = 'none';
            });

            sendEmailBtn.addEventListener('click', sendEmailReport);
            previewEmailBtn.addEventListener('click', showEmailPreview);
            saveEmailTemplateBtn.addEventListener('click', saveEmailTemplate);

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target == emailReportModal) {
                    emailReportModal.style.display = 'none';
                }
            });

            // Actualizar vista previa cuando cambien los filtros del modal
            const modalStartDate = document.getElementById('modalStartDate');
            const modalEndDate = document.getElementById('modalEndDate');
            const modalButlerFilter = document.getElementById('modalButlerFilter');
            
            if (modalStartDate) modalStartDate.addEventListener('change', updateEmailPreview);
            if (modalEndDate) modalEndDate.addEventListener('change', updateEmailPreview);
            if (modalButlerFilter) modalButlerFilter.addEventListener('change', updateEmailPreview);

            // Función para actualizar dashboard con datos filtrados
            function updateDashboardWithFilteredData() {
                // Actualizar contador total
                document.getElementById('totalSurveys').textContent = filteredSurveysData.length;

                // Actualizar promedios
                const fieldsToAverage = [
                    { fieldName: 'overall_staff_service', elementSuffix: 'OverallStaffServiceRating' },
                    { fieldName: 'food_quality', elementSuffix: 'FoodQualityRating' },
                    { fieldName: 'room_condition', elementSuffix: 'RoomConditionRating' },
                    { fieldName: 'preferred_club_service', elementSuffix: 'PreferredClubServiceRating' },
                    { fieldName: 'butler_service_rating', elementSuffix: 'ButlerServiceRating' }
                ];

                fieldsToAverage.forEach(item => {
                    const avg = calculateAverage(filteredSurveysData, item.fieldName);
                    const emoji = getFaceEmoji(avg);
                    const color = getRatingColor(avg);
                    const targetElement = document.getElementById(`avg${item.elementSuffix}`);
                    if (targetElement) {
                        targetElement.innerHTML = `<span style="color: ${color};">${emoji} ${avg}</span>`;
                    }
                });

                // Actualizar gráfico
                if (ratingsChartInstance) {
                    updateChartWithFilteredData();
                }

                // Actualizar comentarios
                renderCommentsSection(filteredSurveysData);
            }

            // Función para actualizar gráfico con datos filtrados
            function updateChartWithFilteredData() {
                const chartLabels = ["Bad", "Poor", "Regular", "Good", "Excellent"];
                const chartData = {
                    'overall_staff_service': Array(5).fill(0),
                    'food_quality': Array(5).fill(0),
                    'room_condition': Array(5).fill(0),
                    'preferred_club_service': Array(5).fill(0),
                    'butler_service_rating': Array(5).fill(0)
                };

                filteredSurveysData.forEach(survey => {
                    const fieldsToAverage = [
                        { fieldName: 'overall_staff_service' },
                        { fieldName: 'food_quality' },
                        { fieldName: 'room_condition' },
                        { fieldName: 'preferred_club_service' },
                        { fieldName: 'butler_service_rating' }
                    ];

                    fieldsToAverage.forEach(item => {
                        const ratingWord = survey[item.fieldName];
                        const numericRating = ratingMap[ratingWord];
                        if (numericRating !== undefined) {
                            chartData[item.fieldName][numericRating - 1]++;
                        }
                    });
                });

                ratingsChartInstance.data.datasets[0].data = chartData['overall_staff_service'];
                ratingsChartInstance.data.datasets[1].data = chartData['food_quality'];
                ratingsChartInstance.data.datasets[2].data = chartData['room_condition'];
                ratingsChartInstance.data.datasets[3].data = chartData['preferred_club_service'];
                ratingsChartInstance.data.datasets[4].data = chartData['butler_service_rating'];
                ratingsChartInstance.update();
            }

            // Variables de paginación para comentarios
            let currentCommentsPage = 1;
            let commentsPerPage = 5; // Mostrar 5 comentarios por página

            // Función para renderizar sección de comentarios con paginación
            function renderCommentsSection(data) {
                const commentsSection = document.getElementById('commentsSection');
                const comments = data.filter(s => s.comments && s.comments.trim() !== '');

                if (comments.length > 0) {
                    // Calcular paginación
                    const totalPages = Math.ceil(comments.length / commentsPerPage);
                    const startIndex = (currentCommentsPage - 1) * commentsPerPage;
                    const endIndex = startIndex + commentsPerPage;
                    const commentsToShow = comments.slice(startIndex, endIndex);

                    // Limpiar sección
                    commentsSection.innerHTML = '';

                    // Renderizar comentarios de la página actual
                    commentsToShow.forEach(comment => {
                        const commentCard = document.createElement('div');
                        commentCard.classList.add('comment-card');
                        const formattedTimestamp = comment.timestamp && comment.timestamp.toDate ? new Date(comment.timestamp.toDate()).toLocaleString('es-DO') : 'N/A';
                        const isNew = isCommentNew(comment.timestamp ? (comment.timestamp.toDate ? comment.timestamp.toDate() : comment.timestamp) : null);
                        commentCard.innerHTML = `
                            <p>${comment.comments}</p>
                            ${isNew ? '<span style="background:#28a745; color:#fff; border-radius:8px; padding:2px 8px; margin-left:8px; font-size:0.9em;">Nuevo</span>' : ''}
                            <small>Habitación: ${comment.room_number || 'N/A'} - Mayordomo: ${comment.butler || 'N/A'} - Enviado: ${formattedTimestamp}</small>
                            <button class="whatsapp-comment-btn" 
                                data-comment="${encodeURIComponent(comment.comments)}"
                                data-room="${encodeURIComponent(comment.room_number || 'N/A')}"
                                data-butler="${encodeURIComponent(comment.butler || 'N/A')}"
                                data-date="${encodeURIComponent(formattedTimestamp)}"
                                style="background:#25D366; color:#fff; border:none; border-radius:6px; padding:6px 14px; margin-top:8px; cursor:pointer;">
                                <span style="font-size:1.2em; vertical-align:middle;">🟢</span> Enviar a WhatsApp
                            </button>
                        `;
                        commentsSection.appendChild(commentCard);
                    });

                    // Agregar controles de paginación
                    if (totalPages > 1) {
                        const paginationContainer = document.createElement('div');
                        paginationContainer.className = 'comments-pagination';
                        paginationContainer.innerHTML = `
                            <div class="pagination-info">
                                <span>Mostrando ${startIndex + 1}-${Math.min(endIndex, comments.length)} de ${comments.length} comentarios</span>
                            </div>
                            <div class="pagination-controls">
                                <button class="pagination-btn" id="prevCommentsPage" ${currentCommentsPage === 1 ? 'disabled' : ''}>
                                    ← Anterior
                                </button>
                                <span class="page-numbers">
                                    ${generatePageNumbers(currentCommentsPage, totalPages)}
                                </span>
                                <button class="pagination-btn" id="nextCommentsPage" ${currentCommentsPage === totalPages ? 'disabled' : ''}>
                                    Siguiente →
                                </button>
                            </div>
                            <div class="pagination-size">
                                <label>Comentarios por página: 
                                    <select id="commentsPerPageSelect">
                                        <option value="3" ${commentsPerPage === 3 ? 'selected' : ''}>3</option>
                                        <option value="5" ${commentsPerPage === 5 ? 'selected' : ''}>5</option>
                                        <option value="10" ${commentsPerPage === 10 ? 'selected' : ''}>10</option>
                                        <option value="15" ${commentsPerPage === 15 ? 'selected' : ''}>15</option>
                                    </select>
                                </label>
                            </div>
                        `;
                        commentsSection.appendChild(paginationContainer);

                        // Event listeners para paginación
                        document.getElementById('prevCommentsPage').addEventListener('click', () => {
                            if (currentCommentsPage > 1) {
                                currentCommentsPage--;
                                renderCommentsSection(data);
                            }
                        });

                        document.getElementById('nextCommentsPage').addEventListener('click', () => {
                            if (currentCommentsPage < totalPages) {
                                currentCommentsPage++;
                                renderCommentsSection(data);
                            }
                        });

                        // Event listener para cambiar número de comentarios por página
                        document.getElementById('commentsPerPageSelect').addEventListener('change', (e) => {
                            commentsPerPage = parseInt(e.target.value);
                            currentCommentsPage = 1; // Volver a la primera página
                            renderCommentsSection(data);
                        });
                    }
                } else {
                    commentsSection.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                            <p style="font-size: 1.1rem; margin-bottom: var(--spacing-sm);">📝 No hay comentarios adicionales</p>
                            <p style="font-size: 0.9rem;">No se encontraron comentarios con los filtros aplicados actualmente.</p>
                        </div>
                    `;
                }
            }

            // Función para generar números de página
            function generatePageNumbers(currentPage, totalPages) {
                let pageNumbers = '';
                const maxVisiblePages = 5;
                
                if (totalPages <= maxVisiblePages) {
                    // Mostrar todas las páginas si hay 5 o menos
                    for (let i = 1; i <= totalPages; i++) {
                        pageNumbers += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToCommentsPage(${i})">${i}</span>`;
                    }
                } else {
                    // Mostrar páginas con elipsis
                    if (currentPage <= 3) {
                        for (let i = 1; i <= 4; i++) {
                            pageNumbers += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToCommentsPage(${i})">${i}</span>`;
                        }
                        pageNumbers += '<span class="page-ellipsis">...</span>';
                        pageNumbers += `<span class="page-number" onclick="goToCommentsPage(${totalPages})">${totalPages}</span>`;
                    } else if (currentPage >= totalPages - 2) {
                        pageNumbers += `<span class="page-number" onclick="goToCommentsPage(1)">1</span>`;
                        pageNumbers += '<span class="page-ellipsis">...</span>';
                        for (let i = totalPages - 3; i <= totalPages; i++) {
                            pageNumbers += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToCommentsPage(${i})">${i}</span>`;
                        }
                    } else {
                        pageNumbers += `<span class="page-number" onclick="goToCommentsPage(1)">1</span>`;
                        pageNumbers += '<span class="page-ellipsis">...</span>';
                        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                            pageNumbers += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToCommentsPage(${i})">${i}</span>`;
                        }
                        pageNumbers += '<span class="page-ellipsis">...</span>';
                        pageNumbers += `<span class="page-number" onclick="goToCommentsPage(${totalPages})">${totalPages}</span>`;
                    }
                }
                
                return pageNumbers;
            }

            // Función global para ir a una página específica
            window.goToCommentsPage = function(pageNumber) {
                currentCommentsPage = pageNumber;
                renderCommentsSection(filteredSurveysData);
            };

            // --- Funcionalidad del Modal de Filtros ---
            const filterBtn = document.getElementById('filterBtn');
            const filterModal = document.getElementById('filterModal');
            const closeFilterModal = document.getElementById('closeFilterModal');
            const modalApplyFiltersBtn = document.getElementById('modalApplyFiltersBtn');
            const modalResetFiltersBtn = document.getElementById('modalResetFiltersBtn');
            const modalSaveFilterPresetBtn = document.getElementById('modalSaveFilterPresetBtn');
            const modalActiveFiltersSummary = document.getElementById('modalActiveFiltersSummary');

            // Función para actualizar el resumen de filtros activos en el modal
            function updateModalActiveFiltersSummary() {
                const startDate = document.getElementById('modalStartDate').value;
                const endDate = document.getElementById('modalEndDate').value;
                const butlerFilter = document.getElementById('modalButlerFilter').value;
                const ratingRangeFilter = document.getElementById('modalRatingRangeFilter').value;
                const commentKeywordFilter = document.getElementById('modalCommentKeywordFilter').value;

                let activeFilters = [];

                if (startDate || endDate) {
                    let dateFilter = 'Período: ';
                    if (startDate && endDate) {
                        dateFilter += `${startDate} a ${endDate}`;
                    } else if (startDate) {
                        dateFilter += `Desde ${startDate}`;
                    } else {
                        dateFilter += `Hasta ${endDate}`;
                    }
                    activeFilters.push(dateFilter);
                }

                if (butlerFilter) {
                    activeFilters.push(`Mayordomo: ${butlerFilter}`);
                }

                if (ratingRangeFilter) {
                    activeFilters.push(`Calificación: ${ratingRangeFilter}`);
                }

                if (commentKeywordFilter) {
                    activeFilters.push(`Palabra clave: "${commentKeywordFilter}"`);
                }

                if (activeFilters.length === 0) {
                    modalActiveFiltersSummary.innerHTML = '<p>No hay filtros aplicados</p>';
                } else {
                    modalActiveFiltersSummary.innerHTML = '<ul>' + activeFilters.map(filter => `<li>${filter}</li>`).join('') + '</ul>';
                }
            }

            // Función para aplicar todos los filtros del modal
            function applyModalFilters() {
                const startDate = document.getElementById('modalStartDate').value;
                const endDate = document.getElementById('modalEndDate').value;
                const butlerFilter = document.getElementById('modalButlerFilter').value;
                const ratingRangeFilter = document.getElementById('modalRatingRangeFilter').value;
                const commentKeywordFilter = document.getElementById('modalCommentKeywordFilter').value;

                // Aplicar filtros de fecha y mayordomo
                const filters = {};
                if (startDate) filters.startDate = startDate;
                if (endDate) filters.endDate = endDate;
                if (butlerFilter) filters.butler = butlerFilter;

                // Recargar dashboard con filtros básicos
                loadDashboard(filters);

                // Aplicar filtros adicionales después de cargar los datos
                setTimeout(() => {
                    let filteredData = [...filteredSurveysData];

                    // Filtro por rango de calificación
                    if (ratingRangeFilter) {
                        filteredData = filteredData.filter(survey => 
                            survey.overall_staff_service === ratingRangeFilter ||
                            survey.food_quality === ratingRangeFilter ||
                            survey.room_condition === ratingRangeFilter ||
                            survey.preferred_club_service === ratingRangeFilter ||
                            survey.butler_service_rating === ratingRangeFilter
                        );
                    }

                    // Filtro por palabra clave en comentarios
                    if (commentKeywordFilter) {
                        filteredData = filteredData.filter(survey => 
                            survey.comments && survey.comments.toLowerCase().includes(commentKeywordFilter.toLowerCase())
                        );
                    }

                    // Actualizar datos filtrados
                    filteredSurveysData = filteredData;
                    filteredAndSearchedData = [...filteredSurveysData];

                    // Actualizar dashboard con datos filtrados
                    updateDashboardWithFilteredData();
                }, 100);
            }

            // Función para limpiar todos los filtros del modal
            function resetModalFilters() {
                document.getElementById('modalStartDate').value = '';
                document.getElementById('modalEndDate').value = '';
                document.getElementById('modalButlerFilter').value = '';
                document.getElementById('modalRatingRangeFilter').value = '';
                document.getElementById('modalCommentKeywordFilter').value = '';
                document.getElementById('modalCompareStart1').value = '';
                document.getElementById('modalCompareEnd1').value = '';
                document.getElementById('modalCompareStart2').value = '';
                document.getElementById('modalCompareEnd2').value = '';
                document.getElementById('modalCompareResult').innerHTML = '';

                updateModalActiveFiltersSummary();
                loadDashboard({});
            }

            // Función para guardar preset de filtros del modal
            function saveModalFilterPreset() {
                const preset = {
                    startDate: document.getElementById('modalStartDate').value,
                    endDate: document.getElementById('modalEndDate').value,
                    butlerFilter: document.getElementById('modalButlerFilter').value,
                    ratingRangeFilter: document.getElementById('modalRatingRangeFilter').value,
                    commentKeywordFilter: document.getElementById('modalCommentKeywordFilter').value,
                    name: prompt('Nombre para el preset de filtros:') || 'Preset ' + new Date().toLocaleDateString()
                };

                if (preset.name) {
                    const savedPresets = JSON.parse(localStorage.getItem('filterPresets') || '[]');
                    savedPresets.push(preset);
                    localStorage.setItem('filterPresets', JSON.stringify(savedPresets));
                    alert('Preset guardado exitosamente.');
                }
            }

            // Event listeners para el modal de filtros
            filterBtn.addEventListener('click', () => {
                filterModal.style.display = 'flex';
                updateModalActiveFiltersSummary();
            });

            closeFilterModal.addEventListener('click', () => {
                filterModal.style.display = 'none';
            });

            modalApplyFiltersBtn.addEventListener('click', () => {
                applyModalFilters();
                filterModal.style.display = 'none';
            });

            modalResetFiltersBtn.addEventListener('click', resetModalFilters);
            modalSaveFilterPresetBtn.addEventListener('click', saveModalFilterPreset);

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target == filterModal) {
                    filterModal.style.display = 'none';
                }
            });

            // Actualizar resumen cuando cambien los filtros del modal
            document.getElementById('modalStartDate').addEventListener('change', updateModalActiveFiltersSummary);
            document.getElementById('modalEndDate').addEventListener('change', updateModalActiveFiltersSummary);
            document.getElementById('modalButlerFilter').addEventListener('change', updateModalActiveFiltersSummary);
            document.getElementById('modalRatingRangeFilter').addEventListener('change', updateModalActiveFiltersSummary);
            document.getElementById('modalCommentKeywordFilter').addEventListener('input', updateModalActiveFiltersSummary);

            // --- Funcionalidad del Modal de Comentarios ---
            const viewCommentsBtn = document.getElementById('viewCommentsBtn');
            const commentsModal = document.getElementById('commentsModal');
            const closeCommentsModal = document.getElementById('closeCommentsModal');
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            // Variables para el modal de comentarios
            let filteredComments = [];
            let filteredEmails = [];

            // Función para cambiar entre tabs
            function switchTab(tabName) {
                tabBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    }
                });

                tabPanels.forEach(panel => {
                    panel.classList.remove('active');
                    if (panel.id === tabName + 'Tab') {
                        panel.classList.add('active');
                    }
                });

                if (tabName === 'comments') {
                    loadComments();
                } else if (tabName === 'emails') {
                    loadEmails();
                }
            }

            // Función para cargar comentarios
            function loadComments() {
                const searchTerm = document.getElementById('commentsSearchInput').value.toLowerCase();
                const ratingFilter = document.getElementById('commentsRatingFilter').value;
                const sortBy = document.getElementById('commentsSortBy').value;

                // Filtrar comentarios
                filteredComments = filteredSurveysData.filter(survey => {
                    if (!survey.comments || survey.comments.trim() === '') return false;
                    
                    // Filtro por búsqueda
                    if (searchTerm && !survey.comments.toLowerCase().includes(searchTerm)) return false;
                    
                    // Filtro por calificación
                    if (ratingFilter) {
                        const hasRating = survey.overall_staff_service === ratingFilter ||
                                        survey.food_quality === ratingFilter ||
                                        survey.room_condition === ratingFilter ||
                                        survey.preferred_club_service === ratingFilter ||
                                        survey.butler_service_rating === ratingFilter;
                        if (!hasRating) return false;
                    }
                    
                    return true;
                });

                // Ordenar comentarios
                filteredComments.sort((a, b) => {
                    const dateA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : a.timestamp) : new Date(0);
                    const dateB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate() : b.timestamp) : new Date(0);
                    
                    switch (sortBy) {
                        case 'date-desc':
                            return dateB - dateA;
                        case 'date-asc':
                            return dateA - dateB;
                        case 'rating-desc':
                            return getAverageRating(b) - getAverageRating(a);
                        case 'rating-asc':
                            return getAverageRating(a) - getAverageRating(b);
                        default:
                            return dateB - dateA;
                    }
                });

                updateCommentsStats();
                renderComments();
            }

            // Función para obtener calificación promedio
            function getAverageRating(survey) {
                const ratings = [
                    survey.overall_staff_service,
                    survey.food_quality,
                    survey.room_condition,
                    survey.preferred_club_service,
                    survey.butler_service_rating
                ].filter(r => r && ratingMap[r]);

                if (ratings.length === 0) return 0;
                return ratings.reduce((sum, r) => sum + ratingMap[r], 0) / ratings.length;
            }

            // Función para actualizar estadísticas de comentarios
            function updateCommentsStats() {
                const total = filteredComments.length;
                const positive = filteredComments.filter(s => getAverageRating(s) >= 4).length;
                const negative = filteredComments.filter(s => getAverageRating(s) <= 2).length;

                document.getElementById('totalCommentsCount').textContent = total;
                document.getElementById('positiveCommentsCount').textContent = positive;
                document.getElementById('negativeCommentsCount').textContent = negative;
            }

            // Función para renderizar comentarios
            function renderComments() {
                const container = document.getElementById('allCommentsContainer');
                const startIndex = (currentCommentsPage - 1) * commentsPerPage;
                const endIndex = startIndex + commentsPerPage;
                const pageComments = filteredComments.slice(startIndex, endIndex);

                container.innerHTML = '';

                if (pageComments.length === 0) {
                    container.innerHTML = '<div class="comment-item"><p style="text-align: center; color: var(--text-secondary);">No hay comentarios que coincidan con los filtros.</p></div>';
                    return;
                }

                pageComments.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.className = 'comment-item';
                    
                    const timestamp = comment.timestamp && comment.timestamp.toDate ? 
                        new Date(comment.timestamp.toDate()).toLocaleString('es-DO') : 'N/A';
                    
                    const avgRating = getAverageRating(comment);
                    const ratingClass = avgRating >= 4 ? 'excellent' : 
                                      avgRating >= 3 ? 'good' : 
                                      avgRating >= 2 ? 'regular' : 
                                      avgRating >= 1 ? 'poor' : 'bad';
                    
                    const ratingText = avgRating >= 4 ? 'Excelente' : 
                                     avgRating >= 3 ? 'Bueno' : 
                                     avgRating >= 2 ? 'Regular' : 
                                     avgRating >= 1 ? 'Malo' : 'Muy Malo';

                    commentItem.innerHTML = `
                        <div class="comment-header">
                            <div class="comment-meta">
                                <span>Habitación: ${comment.room_number || 'N/A'}</span>
                                <span>Mayordomo: ${comment.butler || 'N/A'}</span>
                                <span>${timestamp}</span>
                            </div>
                            <span class="comment-rating ${ratingClass}">${ratingText}</span>
                        </div>
                        <div class="comment-text">${comment.comments}</div>
                    `;
                    
                    container.appendChild(commentItem);
                });

                updateCommentsPagination();
            }

            // Función para actualizar paginación de comentarios
            function updateCommentsPagination() {
                const totalPages = Math.ceil(filteredComments.length / commentsPerPage);
                const pageInfo = document.getElementById('commentsPageInfo');
                const prevBtn = document.getElementById('prevCommentsBtn');
                const nextBtn = document.getElementById('nextCommentsBtn');

                pageInfo.textContent = `Página ${currentCommentsPage} de ${totalPages}`;
                prevBtn.disabled = currentCommentsPage === 1;
                nextBtn.disabled = currentCommentsPage === totalPages;
            }

            // Función para cargar correos
            function loadEmails() {
                const searchTerm = document.getElementById('emailsSearchInput').value.toLowerCase();
                const sortBy = document.getElementById('emailsSortBy').value;

                // Extraer correos de las encuestas (asumiendo que hay un campo email)
                filteredEmails = filteredSurveysData
                    .filter(survey => survey.email && survey.email.trim() !== '')
                    .map(survey => ({
                        email: survey.email,
                        timestamp: survey.timestamp,
                        room: survey.room_number,
                        butler: survey.butler
                    }))
                    .filter(email => {
                        if (searchTerm && !email.email.toLowerCase().includes(searchTerm)) return false;
                        return true;
                    });

                // Ordenar correos
                filteredEmails.sort((a, b) => {
                    const dateA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate() : a.timestamp) : new Date(0);
                    const dateB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate() : b.timestamp) : new Date(0);
                    
                    switch (sortBy) {
                        case 'date-desc':
                            return dateB - dateA;
                        case 'date-asc':
                            return dateA - dateB;
                        case 'email-asc':
                            return a.email.localeCompare(b.email);
                        case 'email-desc':
                            return b.email.localeCompare(a.email);
                        default:
                            return dateB - dateA;
                    }
                });

                updateEmailsStats();
                renderEmails();
            }

            // Función para actualizar estadísticas de correos
            function updateEmailsStats() {
                const total = filteredEmails.length;
                const unique = new Set(filteredEmails.map(e => e.email.toLowerCase())).size;
                const valid = filteredEmails.filter(e => isValidEmail(e.email)).length;

                document.getElementById('totalEmailsCount').textContent = total;
                document.getElementById('uniqueEmailsCount').textContent = unique;
                document.getElementById('validEmailsCount').textContent = valid;
            }

            // Función para validar email
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Función para renderizar correos
            function renderEmails() {
                const container = document.getElementById('allEmailsContainer');
                
                container.innerHTML = '';

                if (filteredEmails.length === 0) {
                    container.innerHTML = '<div class="email-item"><p style="text-align: center; color: var(--text-secondary);">No hay correos capturados en las encuestas.</p></div>';
                    return;
                }

                filteredEmails.forEach(email => {
                    const emailItem = document.createElement('div');
                    emailItem.className = 'email-item';
                    
                    const timestamp = email.timestamp && email.timestamp.toDate ? 
                        new Date(email.timestamp.toDate()).toLocaleString('es-DO') : 'N/A';

                    emailItem.innerHTML = `
                        <div class="email-header">
                            <span class="email-address">${email.email}</span>
                            <span class="email-date">${timestamp}</span>
                        </div>
                        <div class="email-meta">
                            <small>Habitación: ${email.room || 'N/A'} | Mayordomo: ${email.butler || 'N/A'}</small>
                        </div>
                    `;
                    
                    container.appendChild(emailItem);
                });
            }

            // Función para exportar correos
            function exportEmails() {
                if (filteredEmails.length === 0) {
                    alert('No hay correos para exportar.');
                    return;
                }

                const csvContent = [
                    ['Email', 'Fecha', 'Habitación', 'Mayordomo'],
                    ...filteredEmails.map(email => [
                        email.email,
                        email.timestamp && email.timestamp.toDate ? 
                            new Date(email.timestamp.toDate()).toLocaleString('es-DO') : 'N/A',
                        email.room || 'N/A',
                        email.butler || 'N/A'
                    ])
                ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'correos_capturados.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Función para copiar lista de correos
            function copyEmails() {
                if (filteredEmails.length === 0) {
                    alert('No hay correos para copiar.');
                    return;
                }
                // Nuevo formato: email (Habitación: X, Mayordomo: Y)
                const emailList = filteredEmails.map(e => `${e.email} (Habitación: ${e.room || 'N/A'}, Mayordomo: ${e.butler || 'N/A'})`).join(', ');
                navigator.clipboard.writeText(emailList).then(() => {
                    alert('Lista de correos copiada al portapapeles.');
                }).catch(() => {
                    // Fallback para navegadores que no soportan clipboard API
                    const textArea = document.createElement('textarea');
                    textArea.value = emailList;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Lista de correos copiada al portapapeles.');
                });
            }

            // Event listeners para el modal de comentarios
            viewCommentsBtn.addEventListener('click', () => {
                commentsModal.style.display = 'flex';
                switchTab('comments');
            });

            closeCommentsModal.addEventListener('click', () => {
                commentsModal.style.display = 'none';
            });

            // Event listeners para tabs
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });

            // Event listeners para controles de comentarios
            document.getElementById('commentsSearchInput').addEventListener('input', loadComments);
            document.getElementById('commentsRatingFilter').addEventListener('change', loadComments);
            document.getElementById('commentsSortBy').addEventListener('change', loadComments);

            // Event listeners para controles de correos
            document.getElementById('emailsSearchInput').addEventListener('input', loadEmails);
            document.getElementById('emailsSortBy').addEventListener('change', loadEmails);

            // Event listeners para paginación
            document.getElementById('prevCommentsBtn').addEventListener('click', () => {
                if (currentCommentsPage > 1) {
                    currentCommentsPage--;
                    renderComments();
                }
            });

            document.getElementById('nextCommentsBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredComments.length / commentsPerPage);
                if (currentCommentsPage < totalPages) {
                    currentCommentsPage++;
                    renderComments();
                }
            });

            // Event listeners para acciones de correos
            document.getElementById('exportEmailsBtn').addEventListener('click', exportEmails);
            document.getElementById('copyEmailsBtn').addEventListener('click', copyEmails);

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target == commentsModal) {
                    commentsModal.style.display = 'none';
                }
            });
        });

        // Guardar la fecha de la última visita en localStorage
        function markCommentsAsSeen() {
            localStorage.setItem('lastSeenComments', new Date().toISOString());
        }

        // Devuelve true si el comentario es nuevo desde la última visita
        function isCommentNew(commentTimestamp) {
            const lastSeen = localStorage.getItem('lastSeenComments');
            if (!lastSeen) return true;
            return new Date(commentTimestamp) > new Date(lastSeen);
        }

        // Llama a esta función cuando el usuario abre el dashboard
        markCommentsAsSeen();

        // Función para mostrar el detalle de un mayordomo específico
        function showButlerDetail(butlerData) {
            const modal = document.getElementById('butlerDetailModal');
            const content = document.getElementById('butlerDetailContent');
            
            let nivel = 'media', badge = 'Media';
            if (butlerData.npsScore >= 50) { nivel = 'alta'; badge = 'Alta'; }
            else if (butlerData.npsScore < 0) { nivel = 'baja'; badge = 'Baja'; }
            
            // Calcular porcentajes
            const promoterPercentage = butlerData.totalSurveys > 0 ? (butlerData.promoters / butlerData.totalSurveys) * 100 : 0;
            const passivePercentage = butlerData.totalSurveys > 0 ? (butlerData.passives / butlerData.totalSurveys) * 100 : 0;
            const detractorPercentage = butlerData.totalSurveys > 0 ? (butlerData.detractors / butlerData.totalSurveys) * 100 : 0;
            
            // Alturas de las barras del gráfico (máximo 100px)
            const maxHeight = 100;
            const promoterHeight = (promoterPercentage / 100) * maxHeight;
            const passiveHeight = (passivePercentage / 100) * maxHeight;
            const detractorHeight = (detractorPercentage / 100) * maxHeight;
            
            // Generar resumen
            let summaryText = '';
            if (butlerData.npsScore >= 50) {
                summaryText = `Excelente rendimiento! ${butlerData.name} tiene un NPS muy alto, indicando que la mayoría de los huéspedes están muy satisfechos con su servicio.`;
            } else if (butlerData.npsScore >= 0) {
                summaryText = `Buen rendimiento. ${butlerData.name} mantiene un NPS positivo, pero hay oportunidades para mejorar la satisfacción de los huéspedes.`;
            } else {
                summaryText = `Necesita atención. ${butlerData.name} tiene un NPS negativo, indicando que hay más detractores que promotores. Se recomienda revisar el servicio.`;
            }
            
            content.innerHTML = `
                <div class="butler-detail-header">
                    <div class="butler-detail-avatar">${butlerData.name[0] ? butlerData.name[0].toUpperCase() : '?'}</div>
                    <div class="butler-detail-name">${butlerData.name}</div>
                    <div class="butler-detail-nps">${butlerData.npsScore.toFixed(1)}</div>
                    <div class="butler-detail-level ${nivel}">${badge} Efectividad</div>
                </div>
                
                <div class="butler-stats-grid">
                    <div class="butler-stat-card">
                        <div class="butler-stat-icon">📊</div>
                        <div class="butler-stat-number">${butlerData.totalSurveys}</div>
                        <div class="butler-stat-label">Total Encuestas</div>
                    </div>
                    <div class="butler-stat-card">
                        <div class="butler-stat-icon">🎯</div>
                        <div class="butler-stat-number">${butlerData.npsScore.toFixed(1)}</div>
                        <div class="butler-stat-label">NPS Score</div>
                    </div>
                    <div class="butler-stat-card">
                        <div class="butler-stat-icon">👍</div>
                        <div class="butler-stat-number">${butlerData.promoters}</div>
                        <div class="butler-stat-label">Promotores</div>
                        <div class="butler-stat-percentage">${promoterPercentage.toFixed(1)}%</div>
                    </div>
                    <div class="butler-stat-card">
                        <div class="butler-stat-icon">😐</div>
                        <div class="butler-stat-number">${butlerData.passives}</div>
                        <div class="butler-stat-label">Pasivos</div>
                        <div class="butler-stat-percentage">${passivePercentage.toFixed(1)}%</div>
                    </div>
                    <div class="butler-stat-card">
                        <div class="butler-stat-icon">👎</div>
                        <div class="butler-stat-number">${butlerData.detractors}</div>
                        <div class="butler-stat-label">Detractores</div>
                        <div class="butler-stat-percentage">${detractorPercentage.toFixed(1)}%</div>
                    </div>
                </div>
                
                <div class="butler-chart-container">
                    <div class="butler-chart-title">Distribución de Calificaciones</div>
                    <div class="butler-chart-bars">
                        <div class="butler-chart-bar">
                            <div class="butler-chart-bar-fill promoters" style="height: ${promoterHeight}px;"></div>
                            <div class="butler-chart-bar-value">${butlerData.promoters}</div>
                            <div class="butler-chart-bar-label">Promotores</div>
                        </div>
                        <div class="butler-chart-bar">
                            <div class="butler-chart-bar-fill passives" style="height: ${passiveHeight}px;"></div>
                            <div class="butler-chart-bar-value">${butlerData.passives}</div>
                            <div class="butler-chart-bar-label">Pasivos</div>
                        </div>
                        <div class="butler-chart-bar">
                            <div class="butler-chart-bar-fill detractors" style="height: ${detractorHeight}px;"></div>
                            <div class="butler-chart-bar-value">${butlerData.detractors}</div>
                            <div class="butler-chart-bar-label">Detractores</div>
                        </div>
                    </div>
                </div>
                
                <div class="butler-summary">
                    <div class="butler-summary-title">📋 Resumen de Análisis</div>
                    <div class="butler-summary-text">${summaryText}</div>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Event listeners para el modal de detalle
        const butlerDetailModal = document.getElementById('butlerDetailModal');
        const closeButlerDetailModal = document.getElementById('closeButlerDetailModal');

        closeButlerDetailModal.addEventListener('click', () => {
            butlerDetailModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target == butlerDetailModal) {
                butlerDetailModal.style.display = 'none';
            }
        });

        // Función para mostrar el modal de verificación de mayordomos
        const verifyButlersBtn = document.getElementById('verifyButlersBtn');
        const butlerVerificationModal = document.getElementById('butlerVerificationModal');
        const closeButlerVerificationModal = document.getElementById('closeButlerVerificationModal');
        const totalButlersCount = document.getElementById('totalButlersCount');
        const uniqueButlersCount = document.getElementById('uniqueButlersCount');
        const potentialDuplicatesCount = document.getElementById('potentialDuplicatesCount');
        const butlerVerificationList = document.getElementById('butlerVerificationList');
        const saveButlerCorrectionsBtn = document.getElementById('saveButlerCorrectionsBtn');
        const exportButlerListBtn = document.getElementById('exportButlerListBtn');
        const butlerSearchInput = document.getElementById('butlerSearchInput');
        const butlerSortSelect = document.getElementById('butlerSortSelect');
        const butlerListContainer = document.getElementById('butlerListContainer');

        function showButlerVerificationModal() {
            // Analizar todos los mayordomos en los datos
            const butlerAnalysis = analyzeButlers();
            
            // Actualizar estadísticas
            totalButlersCount.textContent = butlerAnalysis.totalMentions;
            uniqueButlersCount.textContent = butlerAnalysis.uniqueButlers.length;
            potentialDuplicatesCount.textContent = butlerAnalysis.potentialDuplicates.length;
            
            // Generar lista de mayordomos
            renderButlerVerificationList(butlerAnalysis);
            
            butlerVerificationModal.style.display = 'flex';
        }

        function analyzeButlers() {
            const butlerCounts = {};
            const butlerData = {};
            
            // Contar menciones y recolectar datos
            filteredSurveysData.forEach(survey => {
                if (survey.butler && survey.butler.trim() !== '') {
                    const name = survey.butler.trim();
                    butlerCounts[name] = (butlerCounts[name] || 0) + 1;
                    
                    if (!butlerData[name]) {
                        butlerData[name] = {
                            name: name,
                            count: 0,
                            surveys: [],
                            npsData: { promoters: 0, passives: 0, detractors: 0 }
                        };
                    }
                    
                    butlerData[name].count++;
                    butlerData[name].surveys.push(survey);
                    
                    // Clasificar para NPS
                    const rating = survey.butler_service_rating;
                    if (rating === "Good" || rating === "Excellent") {
                        butlerData[name].npsData.promoters++;
                    } else if (rating === "Regular") {
                        butlerData[name].npsData.passives++;
                    } else if (rating === "Bad" || rating === "Poor") {
                        butlerData[name].npsData.detractors++;
                    }
                }
            });
            
            // Calcular NPS para cada mayordomo
            Object.values(butlerData).forEach(butler => {
                const total = butler.npsData.promoters + butler.npsData.passives + butler.npsData.detractors;
                if (total > 0) {
                    const promoterPercentage = (butler.npsData.promoters / total) * 100;
                    const detractorPercentage = (butler.npsData.detractors / total) * 100;
                    butler.npsScore = promoterPercentage - detractorPercentage;
                } else {
                    butler.npsScore = 0;
                }
            });
            
            // Identificar posibles duplicados (nombres similares)
            const uniqueButlers = Object.keys(butlerCounts);
            const potentialDuplicates = [];
            
            for (let i = 0; i < uniqueButlers.length; i++) {
                for (let j = i + 1; j < uniqueButlers.length; j++) {
                    const name1 = uniqueButlers[i].toLowerCase();
                    const name2 = uniqueButlers[j].toLowerCase();
                    
                    // Detectar similitudes (mismas iniciales, nombres similares)
                    if (name1[0] === name2[0] && 
                        (name1.includes(name2.substring(0, 3)) || name2.includes(name1.substring(0, 3)))) {
                        potentialDuplicates.push([uniqueButlers[i], uniqueButlers[j]]);
                    }
                }
            }
            
            return {
                totalMentions: Object.values(butlerCounts).reduce((a, b) => a + b, 0),
                uniqueButlers: uniqueButlers,
                potentialDuplicates: potentialDuplicates,
                butlerData: butlerData
            };
        }

        function renderButlerVerificationList(analysis) {
            butlerVerificationList.innerHTML = '';
            
            // Ordenar mayordomos por cantidad de menciones
            const sortedButlers = Object.values(analysis.butlerData)
                .sort((a, b) => b.count - a.count);
            
            sortedButlers.forEach(butler => {
                const item = document.createElement('div');
                item.className = 'butler-verification-item';
                
                // Verificar si es un posible duplicado
                const isDuplicate = analysis.potentialDuplicates.some(dup => 
                    dup.includes(butler.name)
                );
                
                if (isDuplicate) {
                    item.classList.add('potential-duplicate');
                } else if (butler.count === 1) {
                    item.classList.add('unique-butler');
                }
                
                item.innerHTML = `
                    <div class="butler-avatar">${butler.name[0] ? butler.name[0].toUpperCase() : '?'}</div>
                    <div class="butler-info">
                        <div class="butler-name">${butler.name}</div>
                        <div class="butler-details">
                            <span class="butler-count">📊 ${butler.count} menciones</span>
                            <span class="butler-nps">🎯 NPS: ${butler.npsScore.toFixed(1)}</span>
                            <span class="butler-breakdown">
                                👍 ${butler.npsData.promoters} | 😐 ${butler.npsData.passives} | 👎 ${butler.npsData.detractors}
                            </span>
                        </div>
                    </div>
                    <div class="butler-actions">
                        <button class="btn-edit" onclick="editButlerName('${butler.name}')">✏️ Editar</button>
                        <button class="btn-merge" onclick="mergeButler('${butler.name}')" ${isDuplicate ? '' : 'disabled'}>🔄 Fusionar</button>
                    </div>
                `;
                
                butlerVerificationList.appendChild(item);
            });
        }

        function editButlerName(oldName) {
            const newName = prompt(`Editar nombre del mayordomo:\n\nNombre actual: ${oldName}\n\nIngresa el nuevo nombre:`, oldName);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                // Actualizar todos los registros con el nuevo nombre
                filteredSurveysData.forEach(survey => {
                    if (survey.butler === oldName) {
                        survey.butler = newName.trim();
                    }
                });
                
                // Recargar la lista
                const analysis = analyzeButlers();
                renderButlerVerificationList(analysis);
                
                alert(`Nombre actualizado: "${oldName}" → "${newName}"`);
            }
        }

        function mergeButler(butlerName) {
            const analysis = analyzeButlers();
            const duplicates = analysis.potentialDuplicates.filter(dup => dup.includes(butlerName));
            
            if (duplicates.length > 0) {
                const duplicateNames = duplicates.flat().filter(name => name !== butlerName);
                const targetName = prompt(
                    `Fusionar "${butlerName}" con otro mayordomo:\n\nDuplicados encontrados:\n${duplicateNames.join('\n')}\n\nIngresa el nombre correcto para fusionar:`,
                    butlerName
                );
                
                if (targetName && targetName.trim() !== '') {
                    // Fusionar registros
                    filteredSurveysData.forEach(survey => {
                        if (survey.butler === butlerName) {
                            survey.butler = targetName.trim();
                        }
                    });
                    
                    // Recargar la lista
                    const newAnalysis = analyzeButlers();
                    renderButlerVerificationList(newAnalysis);
                    
                    alert(`Fusión completada: "${butlerName}" → "${targetName}"`);
                }
            }
        }

        verifyButlersBtn.addEventListener('click', showButlerVerificationModal);
        closeButlerVerificationModal.addEventListener('click', () => {
            butlerVerificationModal.style.display = 'none';
        });
        window.addEventListener('click', function(event) {
            if (event.target == butlerVerificationModal) {
                butlerVerificationModal.style.display = 'none';
            }
        });

        // Event listeners para el modal de verificación
        butlerSearchInput.addEventListener('input', () => {
            const searchTerm = butlerSearchInput.value.toLowerCase();
            const filteredList = filteredSurveysData.filter(survey => {
                return survey.butler && survey.butler.toLowerCase().includes(searchTerm);
            });
            updateButlerVerificationList(filteredList);
        });

        butlerSortSelect.addEventListener('change', () => {
            const sortBy = butlerSortSelect.value;
            const sortedList = sortButlerList(filteredSurveysData, sortBy);
            updateButlerVerificationList(sortedList);
        });

        function sortButlerList(list, sortBy) {
            switch (sortBy) {
                case 'name':
                    return list.sort((a, b) => a.butler.localeCompare(b.butler));
                case 'count':
                    return list.sort((a, b) => b.butlerCounts - a.butlerCounts);
                case 'nps':
                    return list.sort((a, b) => b.npsScore - a.npsScore);
                default:
                    return list;
            }
        }

        function updateButlerVerificationList(list) {
            butlerListContainer.innerHTML = '';
            list.forEach(survey => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="butler-verification-item">
                        <div class="butler-avatar">${survey.butler[0] ? survey.butler[0].toUpperCase() : '?'}</div>
                        <div class="butler-info">
                            <div class="butler-name">${survey.butler}</div>
                            <div class="butler-nps">NPS: ${survey.npsScore.toFixed(1)}</div>
                        </div>
                    </div>
                `;
                butlerListContainer.appendChild(li);
            });
        }

        saveButlerCorrectionsBtn.addEventListener('click', () => {
            const corrections = [];
            butlerListContainer.querySelectorAll('.butler-verification-item').forEach(item => {
                const name = item.querySelector('.butler-name').textContent;
                const nps = parseFloat(item.querySelector('.butler-nps').textContent.replace('NPS: ', ''));
                corrections.push({ name, nps });
            });
            // Aquí puedes enviar las correcciones a tu backend
            console.log('Correcciones guardadas:', corrections);
            alert('Correcciones guardadas exitosamente.');
            butlerVerificationModal.style.display = 'none';
        });

        exportButlerListBtn.addEventListener('click', () => {
            const csvContent = [
                ['Nombre', 'NPS'],
                ...butlerListContainer.querySelectorAll('.butler-verification-item').map(item => [
                    item.querySelector('.butler-name').textContent,
                    item.querySelector('.butler-nps').textContent
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lista_correcciones.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
